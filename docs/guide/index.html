<!doctype html>
<html lang=en-US>
<meta charset=utf8>
<meta name="viewport" content="width=device-width, initial-scale=1"><title>ProseMirror Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel=stylesheet href=/css/site.css>

<header >
  <nav>
    <a class=logo href="/">ProseMirror</a>
    <div class=navlinks><a class=toc-toggle>Contents</a><a href="/examples/" >Examples</a>
      <a href="/docs/" class=active>Documentation</a>
      <a href="https://discuss.prosemirror.net/">Discuss</a>
      <a href="https://github.com/prosemirror">GitHub</a>
      <a href="https://twitter.com/prosemirror">Twitter</a>
    </div>
  </nav></header><nav id=toc>
    <ul><li><a href="#intro">Introduction</a></li><li><a href="#doc">Documents</a></li><li><a href="#schema">Schemas</a></li><li><a href="#transform">Document transformations</a></li><li><a href="#state">The editor state</a></li><li><a href="#view">The view component</a></li><li><a href="#commands">Commands</a></li><li><a href="#collab">Collaborative editing</a></li></ul>
  </nav>
  <script>
addEventListener("load", function() {
  var toc = document.querySelector("nav#toc")
  var state = "top"
  var footer = document.querySelector("footer"), header = document.querySelector("header")
  function align() {
    var tocRect = toc.getBoundingClientRect(),
        headRect = header.getBoundingClientRect(),
        footRect = footer.getBoundingClientRect()
    if (state == "top" && headRect.bottom <= -40 ||
        state == "bottom" && toc.getBoundingClientRect().top >= 0) {
      toc.style.top = "0"
      toc.style.bottom = ""
      toc.classList.add("fixed")
      state = "fixed"
    } else if (state == "fixed" && headRect.bottom > -40) {
      toc.style.bottom = toc.style.top = ""
      toc.classList.remove("fixed")
      state = "top"
    } else if (state == "fixed" && footRect.top < tocRect.bottom) {
      toc.style.bottom = footRect.height + "px"
      toc.style.top = "auto"
      toc.classList.remove("fixed")
      state = "bottom"
    }
  }
  if (document.body.scrollHeight - header.offsetHeight > innerHeight) {
    align()
    addEventListener("scroll", align)
  }
  document.querySelector(".toc-toggle").addEventListener("click", function() {
    toc.classList.toggle("open")
  })
})
  </script><article><h1>ProseMirror Guide</h1>

<p>This guide describes the various concepts used in the library, and
how they relate to each other. To get a complete picture of the
system, it is recommended to go through it in the order it is
presented in, at least up to the view component section.</p><h2 id=intro>Introduction</h2><p>ProseMirror provides a set of tools and concepts for building rich
text editors, using a user interface inspired by
what-you-see-is-what-you-get, but trying to avoid the pitfalls of that
style of editing.</p>
<p>The main principle of ProseMirror is that your code gets full control
over the document and what happens to it. This document isn't a blob
of HTML, but a custom data structure that only contains elements that
you explicitly allow it to contain, in relations that you specified.
All updates go through a single point, where you can inspect them and
react to them.</p>
<p>The core library is not an easy drop-in component—we are prioritizing
modularity and customizability over simplicity, with the hope that,
in the future, people will distribute drop-in editors based on
ProseMirror. As such, this is more of a Lego set than a Matchbox car.</p>
<p>There are four essential modules, which are required to do any editing at
all, and a number of extension modules maintained by the core team,
which have a status similar to that of 3rd party modules—they provide
useful functionality, but you may omit them or replace them with other
modules that implement similar functionality.</p>
<p>The essential modules are:</p>
<ul>
<li>
<p><a href="/docs/ref/#model"><code>prosemirror-model</code></a> defines the editor's <a href="#doc">document
model</a>, the data structure used to describe the content
of the editor.</p>
</li>
<li>
<p><a href="/docs/ref/#state"><code>prosemirror-state</code></a> provides the data structure that
describes the editor's whole state, including the selection, and a
transaction system for moving from one state to the next.</p>
</li>
<li>
<p><a href="/docs/ref/#view"><code>prosemirror-view</code></a> implements a user interface component
that shows a given editor state as an editable element in the
browser, and handles user interaction with that element.</p>
</li>
<li>
<p><a href="/docs/ref/#transform"><code>prosemirror-transform</code></a> contains functionality for
modifying documents in a way that can be recorded and replayed,
which is the basis for the transactions in the <code>state</code> module, and
which makes the undo history and collaborative editing possible.</p>
</li>
</ul>
<p>In addition, there are modules for <a href="/docs/ref/#commands">basic editing
commands</a>, <a href="/docs/ref/#keymap">binding keys</a>, <a href="/docs/ref/#history">undo
history</a>, <a href="/docs/ref/#inputrules">input macros</a>, <a href="/docs/ref/#collab">collaborative
editing</a>, a <a href="/docs/ref/#schema-basic">simple document schema</a>, and
more under the <a href="https://github.com/prosemirror/">GitHub prosemirror
organization</a>.</p>
<p>The fact that ProseMirror isn't distributed as a single,
browser-loadable script means that you'll probably want to use some
kind of bundler when using it. A bundler is a tool that automatically
finds your script's dependencies, and combines them into a single big
file that you can easily load from a web page. You can read more about
bundling on the web, for example
<a href="https://medium.freecodecamp.org/javascript-modules-part-2-module-bundling-5020383cf306">here</a>.</p>
<h3><a id="intro.my_first_editor"></a>My first editor</h3>
<p>The Lego pieces fit together like this to create a very minimal
editor:</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">schema</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-schema-basic&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">EditorState</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-state&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">EditorView</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-view&quot;</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">body</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>ProseMirror requires you to specify a schema that your document
conforms to, so the first thing this does is import a module with a
basic schema in it.</p>
<p>That schema is then used to create a state, which will generate an
empty document conforming to the schema, and a default selection at
the start of that document. Finally, a view is created for the state,
and appended to <code>document.body</code>. This will render the state's document
as an editable DOM node, and generate state transactions whenever the
user types into it.</p>
<p>The editor isn't very usable yet. If you press enter, for example,
nothing happens, because the core library has no opinion on what enter
should do. We'll get to that in a moment.</p>
<h3><a id="intro.transactions"></a>Transactions</h3>
<p>When the user types, or otherwise interacts with the view, it
generates ‘state transactions’. What that means is that it does not
just modify the document in-place and implicitly update its state in
that way. Instead, every change causes a
<a href="#state.transactions"><em>transaction</em></a> to be created, which describes
the changes that are made to the state, and can be applied to create a
<em>new</em> state, which is then used to update the view.</p>
<p>By default this all happens under the cover, but you can hook into by
writing <a href="#state.plugins">plugins</a> or configuring your view. For
example, this code adds a
<a href="/docs/ref/#view.DirectEditorProps.dispatchTransaction"><code>dispatchTransaction</code></a>
<a href="/docs/ref/#view.EditorProps">prop</a>, which will be called whenever a
transaction is created:</p>
<pre><code class="language-javascript"><span class="tok-comment">// (Imports omitted)</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">body</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">dispatchTransaction</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">transaction</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;Document size went from&quot;</span><span class="tok-punctuation">,</span> <span class="tok-variableName">transaction</span><span class="tok-operator">.</span><span class="tok-propertyName">before</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span><span class="tok-punctuation">,</span>
                <span class="tok-string">&quot;to&quot;</span><span class="tok-punctuation">,</span> <span class="tok-variableName">transaction</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">newState</span> <span class="tok-operator">=</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName">transaction</span><span class="tok-punctuation">)</span>
    <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">updateState</span><span class="tok-punctuation">(</span><span class="tok-variableName">newState</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p><em>Every</em> state update has to go through
<a href="/docs/ref/#view.EditorView.updateState"><code>updateState</code></a>, and every normal
editing update will happen by dispatching a transaction.</p>
<h3><a id="intro.plugins"></a>Plugins</h3>
<p>Plugins are used to extend the behavior of the editor and editor state
in various ways. Some are relatively simple, like the
<a href="/docs/ref/#keymap">keymap</a> plugin that binds <a href="#commands">actions</a> to
keyboard input. Others are more involved, like the
<a href="/docs/ref/#history">history</a> plugin which implements an undo history by
observing transactions and storing their inverse in case the user
wants to undo them.</p>
<p>Let's add those two plugins to our editor to get undo/redo
functionality:</p>
<pre><code class="language-javascript"><span class="tok-comment">// (Omitted repeated imports)</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">undo</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">redo</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">history</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-history&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">keymap</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-keymap&quot;</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">plugins</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">[</span>
    <span class="tok-variableName">history</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
    <span class="tok-variableName">keymap</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-string">&quot;Mod-z&quot;</span><span class="tok-punctuation">:</span> <span class="tok-variableName">undo</span><span class="tok-punctuation">,</span> <span class="tok-string">&quot;Mod-y&quot;</span><span class="tok-punctuation">:</span> <span class="tok-variableName">redo</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">]</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">body</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>Plugins are registered when creating a state (because they get access
to state transactions). After creating a view for this history-enabled
state, you'll be able to press Ctrl-Z (or Cmd-Z on OS X) to undo your
last change.</p>
<h3><a id="intro.commands"></a>Commands</h3>
<p>The <code>undo</code> and <code>redo</code> values that the previous example bound to keys
are a special kind of function called <a href="#commands"><em>commands</em></a>.
Most editing actions are written as commands which can be bound to
keys, hooked up to menus, or otherwise exposed to the user.</p>
<p>The <code>prosemirror-commands</code> package provides a number of basic editing
commands, along with a minimal keymap that you'll probably want to
enable to have things like enter and delete do the expected thing in
your editor.</p>
<pre><code class="language-javascript"><span class="tok-comment">// (Omitted repeated imports)</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">baseKeymap</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-commands&quot;</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">plugins</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">[</span>
    <span class="tok-variableName">history</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
    <span class="tok-variableName">keymap</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-string">&quot;Mod-z&quot;</span><span class="tok-punctuation">:</span> <span class="tok-variableName">undo</span><span class="tok-punctuation">,</span> <span class="tok-string">&quot;Mod-y&quot;</span><span class="tok-punctuation">:</span> <span class="tok-variableName">redo</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
    <span class="tok-variableName">keymap</span><span class="tok-punctuation">(</span><span class="tok-variableName">baseKeymap</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">]</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">body</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>At this point, you have a basically working editor.</p>
<p>To add a menu, additional keybindings for schema-specific things, and
so on, you might want to look into the
<a href="https://github.com/prosemirror/prosemirror-example-setup"><code>prosemirror-example-setup</code></a>
package. This is a module that provides you with an array of plugins
that set up a baseline editor, but as the name suggests, it is meant
more as an example than as a production-level library. For a
real-world deployment, you'll probably want to replace it with custom
code that sets things up exactly the way you want.</p>
<h3><a id="intro.content"></a>Content</h3>
<p>A state's document lives under its <a href="/docs/ref/#state.EditorState.doc"><code>doc</code></a>
property. This is a read-only data structure, representing the
document as a hierarchy of nodes, somewhat like the browser DOM. A
simple document might be a <code>&quot;doc&quot;</code> node containing two <code>&quot;paragraph&quot;</code>
nodes, each containing a single <code>&quot;text&quot;</code> node.</p>
<p>When initializing a state, you can give it an initial document to use.
In that case, the <code>schema</code> field is optional, since the schema can be
taken from the document.</p>
<p>Here we initialize a state by parsing the content found in the DOM
element with the ID <code>&quot;content&quot;</code>, using the DOM parser mechanism, which
uses information supplied by the schema about which DOM nodes map to
which elements in that schema:</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">DOMParser</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-model&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">EditorState</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-state&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">schema</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-schema-basic&quot;</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">content</span> <span class="tok-operator">=</span> <span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">getElementById</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;content&quot;</span><span class="tok-punctuation">)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-variableName">DOMParser</span><span class="tok-operator">.</span><span class="tok-propertyName">fromSchema</span><span class="tok-punctuation">(</span><span class="tok-variableName">schema</span><span class="tok-punctuation">)</span><span class="tok-operator">.</span><span class="tok-propertyName">parse</span><span class="tok-punctuation">(</span><span class="tok-variableName">content</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<h2 id=doc>Documents</h2><style>
  .box {
    color: white;
    display: inline-block;
    border-radius: 5px;
    padding: 3px 6px;
    margin: 3px 0;
    vertical-align: top;
  }
</style>
<p>ProseMirror defines its own <a href="/docs/ref/#model.Node">data structure</a> to
represent content documents. Since documents are the central element
around which the rest of the editor is built, it is helpful to
understand how they work.</p>
<h3><a id="doc.structure"></a>Structure</h3>
<p>A ProseMirror document is a <a href="/docs/ref/#model.Node">node</a>, which holds a
<a href="/docs/ref/#model.Fragment">fragment</a> containing zero or more child nodes.</p>
<p>This is a lot like the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model">browser
DOM</a>,
in that it is recursive and tree-shaped. But it differs from the DOM
in the way it stores inline content.</p>
<p>In HTML, a paragraph with markup is represented as a tree, like this:</p>
<pre><code class="language-html"><span class="tok-punctuation">&lt;</span><span class="tok-typeName">p</span><span class="tok-punctuation">&gt;</span>This is <span class="tok-punctuation">&lt;</span><span class="tok-typeName">strong</span><span class="tok-punctuation">&gt;</span>strong text with <span class="tok-punctuation">&lt;</span><span class="tok-typeName">em</span><span class="tok-punctuation">&gt;</span>emphasis<span class="tok-punctuation">&lt;/</span><span class="tok-typeName">em</span><span class="tok-punctuation">&gt;</span><span class="tok-punctuation">&lt;/</span><span class="tok-typeName">strong</span><span class="tok-punctuation">&gt;</span><span class="tok-punctuation">&lt;/</span><span class="tok-typeName">p</span><span class="tok-punctuation">&gt;</span>
</code></pre>
<div class=figure>
  <div class=box style="background: #77e">
    <strong>p</strong><br>
    "This is "
    <div class=box style="background: #55b">
      <strong>strong</strong><br>
      "strong text with "
      <div class=box style="background: #77e">
        <strong>em</strong><br>
        "emphasis"
      </div>
    </div>
  </div>
</div>
<p>Whereas in ProseMirror, the inline content is modeled as a flat
sequence, with the markup attached as metadata to the nodes:</p>
<div class=figure>
  <div class=box style="background: #77e">
    <strong>paragraph</strong><br>
    <div class=box style="background: #55b">
      "This is "
    </div>
    <div class=box style="background: #55b">
      "strong text with "<br>
      <div class=box style="background: #d94">
        <strong>strong</strong>
      </div>
    </div>
    <div class=box style="background: #55b">
      "emphasis"<br>
      <div class=box style="background: #d94">
        <strong>strong</strong>
      </div>
      <div class=box style="background: #d94">
        <strong>em</strong>
      </div>
    </div>
  </div>
</div>
<p>This more closely matches the way we tend to think about
and work with such text. It allows us to represent positions in a
paragraph using a character offset rather than a path in a tree, and
makes it easier to perform operations like splitting or changing the
style of the content without performing awkward tree manipulation.</p>
<p>This also means each document has <em>one</em> valid representation. Adjacent
text nodes with the same set of marks are always combined together,
and empty text nodes are not allowed. The order in which marks appear
is specified by the schema.</p>
<p>So a ProseMirror document is a tree of block nodes, with most of the
leaf nodes being <em>textblocks</em>, which are block nodes that contain
text. You can also have leaf blocks that are simply empty, for example
a horizontal rule or a video element.</p>
<p>Node objects come with a number of properties that reflect the role
they play in the document:</p>
<ul>
<li><code>isBlock</code> and <code>isInline</code> tell you whether a given node is a block
or inline node.</li>
<li><code>inlineContent</code> is true for nodes that expect inline nodes as
content.</li>
<li><code>isTextblock</code> is true for block nodes with inline content.</li>
<li><code>isLeaf</code> tells you that a node doesn't allow any content.</li>
</ul>
<p>So a typical <code>&quot;paragraph&quot;</code> node will be a textblock, whereas a
blockquote might be a block element whose content consists of other
blocks. Text, hard breaks, and inline images are inline leaf nodes,
and a horizontal rule node would be an example of a block leaf node.</p>
<p>The <a href="#schema">schema</a> is allowed to specify more precise
constraints on what may appear where—i.e. even though a node allows
block content, that doesn't mean that it allows <em>all</em> block nodes as
content.</p>
<h3><a id="doc.identity_and_persistence"></a>Identity and persistence</h3>
<p>Another important difference between a DOM tree and a ProseMirror
document is the way the objects that represent nodes behave. In the
DOM, nodes are mutable objects with an <em>identity</em>, which means that a
node can only appear in one parent node, and that the node object
is mutated when it is updated.</p>
<p>In ProseMirror, on the other hand, nodes are simply <em>values</em>, and
should be approached much as you'd approach the value representing the
number 3. 3 can appear in multiple data structures at the same time,
it does not have a parent-link to the data structure it is currently
part of, and if you add 1 to it, you get a <em>new</em> value, 4, without
changing anything about the original 3.</p>
<p>So it is with pieces of ProseMirror documents. They don't change, but
can be used as a starting value to compute a modified piece of
document. They don't know what data structures they are part of, but
can be part of multiple structures, or even occur multiple times in a
single structure. They are <em>values</em>, not stateful objects.</p>
<p>This means that every time you update a document, you get a new
document value. That document value will share all sub-nodes that
didn't change with the original document value, making it relatively
cheap to create.</p>
<p>This has a bunch of advantages. It makes it impossible to have an
editor in an invalid in-between state during an update, since the new
state, with a new document, can be swapped in instantaneously. It also
makes it easier to reason about documents in a somewhat mathematical
way, which is really hard if your values keep changing underneath you.
This helps make collaborative editing possible and allows ProseMirror
to run a very efficient DOM <a href="/docs/ref/#view.EditorView.update">update</a>
algorithm by comparing the last document it drew to the screen to the
current document.</p>
<p>Because such nodes are represented by regular JavaScript objects, and
explicitly
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze">freezing</a>
their properties hampers performance, it is actually <em>possible</em> to
change them. But doing this is not supported, and will cause things to
break, because they are almost always shared between multiple data
structures. So be careful! And note that this also holds for the
arrays and plain objects that are <em>part</em> of node objects, such as the
objects used to store node attributes, or the arrays of child nodes in
fragments.</p>
<h3><a id="doc.data_structures"></a>Data structures</h3>
<p>The object structure for a document looks something like this:</p>
<style>
  .classbox { border-radius: 8px; padding: 4px 10px; color: white; display: inline-block; vertical-align: middle; }
  .classbox td { vertical-align: top; padding: 0; border-right: 5px solid transparent; }
</style>
<div class=classbox style="background: #77e; margin-left: 20px">
  <table style="cell-spacing: collapse">
    <tr><td><strong>Node</strong></td></tr>
    <tr>
      <td>type:</td>
      <td><div class=classbox style="background: #446"><strong>NodeType</strong></div></td>
    </tr>
    <tr>
      <td>content:</td>
      <td><div class=classbox style="background: #44e"><strong>Fragment</strong><br>
        [<div class=classbox style="background: #77e"><strong>Node</strong></div>,
         <div class=classbox style="background: #77e"><strong>Node</strong></div>, ...]</td>
    </tr>
    <tr>
      <td>attrs:</td>
      <td><div class=classbox style="background: #99e"><strong>Object</strong></div></td>
    </tr>
    <tr>
      <td>marks:</td>
      <td>[<div class=classbox style="background: #55b">
        <table style="cell-spacing: collapse">
          <tr><td><strong>Mark</strong></td></tr>
          <tr>
            <td>type:</td>
            <td><div class=classbox style="background: #446"><strong>MarkType</strong></div></td>
          </tr>
          <tr>
           <td>attrs:</td>
           <td><div class=classbox style="background: #99e"><strong>Object</strong></div></td>
         </tr>
       </table></div>, ...]</td>
    </tr>
  </table>
</div>
<p>Each node is represented by an instance of the <a href="/docs/ref/#model.Node"><code>Node</code></a>
class. It is tagged with a <a href="/docs/ref/#model.NodeType">type</a>, which knows the
node's name, the attributes that are valid for it, and so on. Node
types (and mark types) are created once per schema, and know which
schema they are part of.</p>
<p>The content of a node is stored in an instance of
<a href="/docs/ref/#model.Fragment"><code>Fragment</code></a>, which holds a sequence of nodes. Even
for nodes that don't have or don't allow content, this field is filled
(with the shared <a href="/docs/ref/#model.Fragment%5Eempty">empty fragment</a>).</p>
<p>Some node types allow attributes, which are extra values stored with
each node. For example, an image node might use these to store its alt
text and the URL of the image.</p>
<p>In addition, inline nodes hold a set of active marks—things like
emphasis or being a link—which are represented as an array of
<a href="/docs/ref/#model.Mark"><code>Mark</code></a> instances.</p>
<p>A full document is just a node. The document content is represented as
the top-level node's child nodes. Typically, it'll contain a series of
block nodes, some of which may be textblocks that contain inline
content. But the top-level node may also be a textblock itself, so
that the document contains only inline content.</p>
<p>What kind of node is allowed where is determined by the document's
<a href="#schema">schema</a>. To programmatically create nodes, you must go
through the schema, for example using the
<a href="/docs/ref/#model.Schema.node"><code>node</code></a> and <a href="/docs/ref/#model.Schema.text"><code>text</code></a>
methods.</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">schema</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-schema-basic&quot;</span>

<span class="tok-comment">// (The null arguments are where you can specify attributes, if necessary.)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">doc</span> <span class="tok-operator">=</span> <span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;doc&quot;</span><span class="tok-punctuation">,</span> <span class="tok-keyword">null</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">[</span>
  <span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;paragraph&quot;</span><span class="tok-punctuation">,</span> <span class="tok-keyword">null</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">[</span><span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">text</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;One.&quot;</span><span class="tok-punctuation">)</span><span class="tok-punctuation">]</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
  <span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;horizontal_rule&quot;</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
  <span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;paragraph&quot;</span><span class="tok-punctuation">,</span> <span class="tok-keyword">null</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">[</span><span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">text</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;Two!&quot;</span><span class="tok-punctuation">)</span><span class="tok-punctuation">]</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">]</span><span class="tok-punctuation">)</span>
</code></pre>
<h3><a id="doc.indexing"></a>Indexing</h3>
<p>ProseMirror nodes support two types of indexing—they can be treated as
trees, using offsets into individual nodes, or they can be treated as
a flat sequence of tokens.</p>
<p>The first allows you to do things similar to what you'd do with the
DOM—interacting with single nodes, directly accessing child nodes
using the <a href="/docs/ref/#model.Node.child"><code>child</code> method</a> and
<a href="/docs/ref/#model.Node.childCount"><code>childCount</code></a>, writing recursive functions
that scan through a document (if you just want to look at all nodes,
use <a href="/docs/ref/#model.Node.descendants"><code>descendants</code></a> or
<a href="/docs/ref/#model.Node.nodesBetween"><code>nodesBetween</code></a>).</p>
<p>The second is more useful when addressing a specific position in the
document. It allows any document position to be represented as an
integer—the index in the token sequence. These tokens don't actually
exist as objects in memory—they are just a counting convention—but the
document's tree shape, along with the fact that each node knows its
size, is used to make by-position access cheap.</p>
<ul>
<li>
<p>The start of the document, right before the first content, is
position 0.</p>
</li>
<li>
<p>Entering or leaving a node that is not a leaf node (i.e. supports
content) counts as one token. So if the document starts with a
paragraph, the start of that paragraph counts as position 1.</p>
</li>
<li>
<p>Each character in text nodes counts as one token. So if the
paragraph at the start of the document contains the word “hi”,
position 2 is after the “h”, position 3 after the “i”, and position
4 after the whole paragraph.</p>
</li>
<li>
<p>Leaf nodes that do not allow content (such as images) also count as
a single token.</p>
</li>
</ul>
<p>So if you have a document that, when expressed as HTML, would look
like this:</p>
<pre><code class="language-html"><span class="tok-punctuation">&lt;</span><span class="tok-typeName">p</span><span class="tok-punctuation">&gt;</span>One<span class="tok-punctuation">&lt;/</span><span class="tok-typeName">p</span><span class="tok-punctuation">&gt;</span>
<span class="tok-punctuation">&lt;</span><span class="tok-typeName">blockquote</span><span class="tok-punctuation">&gt;</span><span class="tok-punctuation">&lt;</span><span class="tok-typeName">p</span><span class="tok-punctuation">&gt;</span>Two<span class="tok-punctuation">&lt;</span><span class="tok-typeName">img</span> <span class="tok-propertyName">src</span><span class="tok-operator">=</span><span class="tok-string">&quot;...&quot;</span><span class="tok-punctuation">&gt;</span><span class="tok-punctuation">&lt;/</span><span class="tok-typeName">p</span><span class="tok-punctuation">&gt;</span><span class="tok-punctuation">&lt;/</span><span class="tok-typeName">blockquote</span><span class="tok-punctuation">&gt;</span>
</code></pre>
<p>The token sequence, with positions, looks like this:</p>
<pre><code>0   1 2 3 4    5
 &lt;p&gt; O n e &lt;/p&gt;

5            6   7 8 9 10    11   12            13
 &lt;blockquote&gt; &lt;p&gt; T w o &lt;img&gt; &lt;/p&gt; &lt;/blockquote&gt;
</code></pre>
<p>Each node has a <a href="/docs/ref/#model.Node.nodeSize"><code>nodeSize</code></a> property that
gives you the size of the entire node, and you can access
<a href="/docs/ref/#model.Fragment.size"><code>.content.size</code></a> to get the size of the node's
<em>content</em>. Note that for the outer document node, the open and close
tokens are not considered part of the document (because you can't put
your cursor outside of the document), so the size of a document is
<code>doc.content.size</code>, <strong>not</strong> <code>doc.nodeSize</code>.</p>
<p>Interpreting such positions manually involves quite a lot of counting.
You can call <a href="/docs/ref/#model.Node.resolve"><code>Node.resolve</code></a> to get a more
descriptive <a href="/docs/ref/#model.ResolvedPos">data structure</a> for a position. This
data structure will tell you what the parent node of the position is,
what its offset into that parent is, what ancestors the parent has,
and a few other things.</p>
<p>Take care to distinguish between child indices (as per
<a href="/docs/ref/#model.Node.childCount"><code>childCount</code></a>), document-wide positions, and
node-local offsets (sometimes used in recursive functions to represent
a position into the node that's currently being handled).</p>
<h3><a id="doc.slices"></a>Slices</h3>
<p>To handle things like copy-paste and drag-drop, it is necessary to be
able to talk about a slice of document, i.e. the content between two
positions. Such a slice differs from a full node or fragment in that
some of the nodes at its start or end may be ‘open’.</p>
<p>For example, if you select from the middle of one paragraph to the
middle of the next one, the slice you've selected has two paragraphs
in it, the first one open at the start, the second open at the end,
whereas if you node-select a paragraph, you've selected a closed node.
It may be the case that the content in such open nodes violates the
schema constraints, if treated like the node's full content, because
some required nodes fell outside of the slice.</p>
<p>The <a href="/docs/ref/#model.Slice"><code>Slice</code></a> data structure is used to represent such
slices. It stores a <a href="/docs/ref/#model.Fragment">fragment</a> along with an <a href="/docs/ref/#model.Slice.openStart">open
depth</a> on both sides. You can use the
<a href="/docs/ref/#model.Node.slice"><code>slice</code> method</a> on nodes to cut a slice out of a
document.</p>
<pre><code class="language-javascript"><span class="tok-comment">// doc holds two paragraphs, containing text &quot;a&quot; and &quot;b&quot;</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">slice1</span> <span class="tok-operator">=</span> <span class="tok-variableName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">slice</span><span class="tok-punctuation">(</span><span class="tok-number">0</span><span class="tok-punctuation">,</span> <span class="tok-number">3</span><span class="tok-punctuation">)</span> <span class="tok-comment">// The first paragraph</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">slice1</span><span class="tok-operator">.</span><span class="tok-propertyName">openStart</span><span class="tok-punctuation">,</span> <span class="tok-variableName">slice1</span><span class="tok-operator">.</span><span class="tok-propertyName">openEnd</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 0 0</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">slice2</span> <span class="tok-operator">=</span> <span class="tok-variableName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">slice</span><span class="tok-punctuation">(</span><span class="tok-number">1</span><span class="tok-punctuation">,</span> <span class="tok-number">5</span><span class="tok-punctuation">)</span> <span class="tok-comment">// From start of first paragraph</span>
                             <span class="tok-comment">// to end of second</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">slice2</span><span class="tok-operator">.</span><span class="tok-propertyName">openStart</span><span class="tok-punctuation">,</span> <span class="tok-variableName">slice2</span><span class="tok-operator">.</span><span class="tok-propertyName">openEnd</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 1 1</span>
</code></pre>
<h3><a id="doc.changing"></a>Changing</h3>
<p>Since nodes and fragments are
<a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent</a>,
you should <strong>never</strong> mutate them. If you have a handle to a document
(or node, or fragment) that object will stay the same.</p>
<p>Most of the time, you'll use <a href="#transform">transformations</a> to
update documents, and won't have to directly touch the nodes. These
also leave a record of the changes, which is necessary when the
document is part of an editor state.</p>
<p>In cases where you do want to 'manually' derive an updated document,
there are some helper methods available on the <a href="/docs/ref/#model.Node"><code>Node</code></a>
and <a href="/docs/ref/#model.Fragment"><code>Fragment</code></a> types. To create an updated version
of a whole document, you'll usually want to use
<a href="/docs/ref/#model.Node.replace"><code>Node.replace</code></a>, which replaces a given range
of the document with a <a href="/docs/ref/#model.Slice">slice</a> of new content. To
update a node shallowly, you can use its <a href="/docs/ref/#model.Node.copy"><code>copy</code></a>
method, which creates a similar node with new content. Fragments also
have various updating methods, such as
<a href="/docs/ref/#model.Fragment.replaceChild"><code>replaceChild</code></a> or
<a href="/docs/ref/#model.Fragment.append"><code>append</code></a>.</p>
<h2 id=schema>Schemas</h2><p>Each ProseMirror <a href="#doc">document</a> has a <a href="/docs/ref/#model.Schema">schema</a>
associated with it. The schema describes the kind of
<a href="/docs/ref/#model.Node">nodes</a> that may occur in the document, and the way they
are nested. For example, it might say that the top-level node can
contain one or more blocks, and that paragraph nodes can contain any
number of inline nodes, with any <a href="/docs/ref/#model.Mark">marks</a> applied to
them.</p>
<p>There is a package with a <a href="/docs/ref/#schema-basic">basic schema</a> available,
but the nice thing about ProseMirror is that it allows you to define
your own schemas.</p>
<h3><a id="schema.node_types"></a>Node Types</h3>
<p>Every node in a document has a <a href="/docs/ref/#model.NodeType">type</a>, which
represents its semantic meaning and its properties, such as the way it
is rendered in the editor.</p>
<p>When you define a schema, you enumerate the node types that may occur
within it, describing each with a <a href="/docs/ref/#model.NodeSpec">spec object</a>:</p>
<pre><code class="language-javascript"><span class="tok-keyword">const</span> <span class="tok-variableName tok-definition">trivialSchema</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Schema</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">nodes</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;paragraph+&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">paragraph</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;text*&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">text</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">inline</span><span class="tok-punctuation">:</span> <span class="tok-bool">true</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-comment">/* ... and so on */</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>That defines a schema where the document may contain one or more
paragraphs, and each paragraph can contain any amount of text.</p>
<p>Every schema must at least define a top-level node type (which
defaults to the name <code>&quot;doc&quot;</code>, but you can
<a href="/docs/ref/#model.Schema.topNodeType">configure</a> that), and a <code>&quot;text&quot;</code> type for
text content.</p>
<p>Nodes that count as inline must declare this with the
<a href="/docs/ref/#model.NodeSpec.inline"><code>inline</code></a> property (though for the <code>text</code>
type, which is inline by definition, you may omit this).</p>
<h3><a id="schema.content_expressions"></a>Content Expressions</h3>
<p>The strings in the <a href="/docs/ref/#model.NodeSpec.content"><code>content</code></a> fields in the
example schema above are called <em>content expressions</em>. They control
what sequences of child nodes are valid for this node type.</p>
<p>You can say, for example <code>&quot;paragraph&quot;</code> for “one paragraph”, or
<code>&quot;paragraph+&quot;</code> to express “one or more paragraphs”. Similarly,
<code>&quot;paragraph*&quot;</code> means “zero or more paragraphs” and <code>&quot;caption?&quot;</code> means
“zero or one caption node”. You can also use regular-expression-like
ranges, such as <code>{2}</code> (“exactly two”) <code>{1, 5}</code> (“one to five”) or
<code>{2,}</code> (“two or more”) after node names.</p>
<p>Such expressions can be combined to create a sequence, for example
<code>&quot;heading paragraph+&quot;</code> means ‘first a heading, then one or more
paragraphs’. You can also use the pipe <code>|</code> operator to indicate a
choice between two expressions, as in <code>&quot;(paragraph | blockquote)+&quot;</code>.</p>
<p>Some groups of element types will appear multiple times in your
schema—for example you might have a concept of “block” nodes, that may
appear at the top level but also nested inside of blockquotes. You can
create a node group by giving your node specs a
<a href="/docs/ref/#model.NodeSpec.group"><code>group</code></a> property, and then refer to that
group by its name in your expressions.</p>
<pre><code class="language-javascript"><span class="tok-keyword">const</span> <span class="tok-variableName tok-definition">groupSchema</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Schema</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">nodes</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block+&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">paragraph</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">group</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;text*&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">blockquote</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">group</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block+&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">text</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>Here <code>&quot;block+&quot;</code> is equivalent to <code>&quot;(paragraph | blockquote)+&quot;</code>.</p>
<p>It is recommended to always require at least one child node in nodes
that have block content (such as <code>&quot;doc&quot;</code> and <code>&quot;blockquote&quot;</code> in the
example above), because browsers will completely collapse the node
when it's empty, making it rather hard to edit.</p>
<p>The order in which your nodes appear in an or-expression is
significant. When creating a default instance for a non-optional node,
for example to make sure a document still conforms to the schema after
a <a href="/docs/ref/#transform.ReplaceStep">replace step</a> the first type in the
expression will be used. If that is a group, the first type in the
group (determined by the order in which the group's members appear in
your <code>nodes</code> map) is used. If I switched the positions of
<code>&quot;paragraph&quot;</code> and <code>&quot;blockquote&quot;</code> in the the example schema, you'd get
a stack overflow as soon as the editor tried to create a block
node—it'd create a <code>&quot;blockquote&quot;</code> node, whose content requires at
least one block, so it'd try to create another <code>&quot;blockquote&quot;</code> as
content, and so on.</p>
<p>Not every node-manipulating function in the library checks that it is
dealing with valid content—higher level concepts like
<a href="#transform">transforms</a> do, but primitive node-creation methods
usually don't and instead put the responsibility for providing sane
input on their caller. It is perfectly possible to use, for example
<a href="/docs/ref/#model.NodeType.create"><code>NodeType.create</code></a>, to create a node with
invalid content. For nodes that are ‘open’ on the edge of
<a href="#doc.slices">slices</a>, this is even a reasonable thing to do. There
is a separate <a href="/docs/ref/#model.NodeType.createChecked"><code>createChecked</code>
method</a>, as well as an after-the-fact
<a href="/docs/ref/#model.Node.check"><code>check</code> method</a> that can be used to assert that a
given node's content is valid.</p>
<h3><a id="schema.marks"></a>Marks</h3>
<p>Marks are used to add extra styling or other information to inline
content. A schema must declare all mark types it allows in its
<a href="/docs/ref/#model.Schema">schema</a>. <a href="/docs/ref/#model.MarkType">Mark types</a> are objects
much like node types, used to tag mark objects and provide additional
information about them.</p>
<p>By default, nodes with inline content allow all marks defined in the
schema to be applied to their children. You can configure this with
the <a href="/docs/ref/#model.NodeSpec.marks"><code>marks</code></a> property on your node spec.</p>
<p>Here's a simple schema that supports strong and emphasis marks on
text in paragraphs, but not in headings:</p>
<pre><code class="language-javascript"><span class="tok-keyword">const</span> <span class="tok-variableName tok-definition">markSchema</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Schema</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">nodes</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block+&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">paragraph</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">group</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;text*&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">marks</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;_&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">heading</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">group</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;block&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;text*&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">marks</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">text</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">inline</span><span class="tok-punctuation">:</span> <span class="tok-bool">true</span><span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">marks</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">strong</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">em</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>The set of marks is interpreted as a space-separated string of mark
names or mark groups—<code>&quot;_&quot;</code> acts as a wildcard, and the empty string
corresponds to the empty set.</p>
<h3><a id="schema.attributes"></a>Attributes</h3>
<p>The document schema also defines which <em>attributes</em> each node or mark
has. If your node type requires extra node-specific information to be
stored, such as the level of a heading node, that is best done with an
attribute.</p>
<p>Attribute sets are represented as plain objects with a predefined (per
node or mark) set of properties holding any JSON-serializeable values.
To specify what attributes it allows, use the optional <code>attrs</code> field
in a node or mark spec.</p>
<pre><code class="language-javascript">  <span class="tok-labelName">heading</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-labelName">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;text*&quot;</span><span class="tok-punctuation">,</span>
    <span class="tok-variableName">attrs</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-labelName">level</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-keyword">default</span><span class="tok-punctuation">:</span> <span class="tok-number">1</span><span class="tok-punctuation">}</span><span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
</code></pre>
<p>In this schema, every instance of the <code>heading</code> node will have a
<code>level</code> attribute under <code>.attrs.level</code>. If it isn't specified when the
node is <a href="/docs/ref/#model.NodeType.create">created</a>, it will default to 1.</p>
<p><a id="generatable"></a>When you don't give a default value for an
attribute, an error will be raised when you attempt to create such a
node without specifying that attribute.</p>
<p>That will also make it impossible for the library to generate such
nodes as filler to satisfy schema constraints during a transform or
when calling <a href="/docs/ref/#model.NodeType.createAndFill"><code>createAndFill</code></a>. This
is why you are not allowed to put such nodes in a required position in
the schema—in order to be able to enforce the schema constraints, the
editor needs to be able to generate empty nodes to fill missing pieces
in the content.</p>
<h3><a id="schema.serialization_and_parsing"></a>Serialization and Parsing</h3>
<p>In order to be able to edit them in the browser, it must be possible
to represent document nodes in the browser DOM. The easiest way to do
that is to include information about each node's DOM representation in
the schema using the <a href="/docs/ref/#model.NodeSpec.toDOM"><code>toDOM</code> field</a> in the
node spec.</p>
<p>This field should hold a function that, when called with the node as
argument, returns a description of the DOM structure for that node.
This may either be a direct DOM node or an <a href="/docs/ref/#model.DOMOutputSpec">array describing
it</a>, for example:</p>
<pre><code class="language-javascript"><span class="tok-keyword">const</span> <span class="tok-variableName tok-definition">schema</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Schema</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">nodes</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;paragraph+&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">paragraph</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
      <span class="tok-propertyName tok-definition">content</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;text*&quot;</span><span class="tok-punctuation">,</span>
      <span class="tok-propertyName tok-definition">toDOM</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-punctuation">[</span><span class="tok-string">&quot;p&quot;</span><span class="tok-punctuation">,</span> <span class="tok-number">0</span><span class="tok-punctuation">]</span> <span class="tok-punctuation">}</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">text</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>The expression <code>[&quot;p&quot;, 0]</code> declares that a paragraph is rendered as an
HTML <code>&lt;p&gt;</code> tag. The zero is the ‘hole’ where its content should be
rendered. You may also include an object with HTML attributes after
the tag name, for example <code>[&quot;div&quot;, {class: &quot;c&quot;}, 0]</code>. Leaf nodes don't
need a hole in their DOM representation, since they don't have
content.</p>
<p>Mark specs allow a similar <a href="/docs/ref/#model.MarkSpec.toDOM"><code>toDOM</code></a> method,
but they are required to render as a single tag that directly wraps
the content, so the content always goes directly in the returned node,
and the hole doesn't need to be specified.</p>
<p>You'll also often need to <em>parse</em> a document from DOM data, for
example when the user pastes or drags something into the editor. The
model module also comes with functionality for that, and you are
encouraged to include parsing information directly in your schema with
the <a href="/docs/ref/#model.NodeSpec.parseDOM"><code>parseDOM</code> property</a>.</p>
<p>This may list an array of <a href="/docs/ref/#model.ParseRule"><em>parse rules</em></a>, which
describe DOM constructs that map to a given node or mark. For example,
the basic schema has these for the emphasis mark:</p>
<pre><code class="language-javascript">  <span class="tok-labelName">parseDOM</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">[</span>
    <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">tag</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;em&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>                 <span class="tok-comment">// Match &lt;em&gt; nodes</span>
    <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">tag</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;i&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>                  <span class="tok-comment">// and &lt;i&gt; nodes</span>
    <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">style</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;font-style=italic&quot;</span><span class="tok-punctuation">}</span> <span class="tok-comment">// and inline 'font-style: italic'</span>
  <span class="tok-punctuation">]</span>
</code></pre>
<p>The value given to <a href="/docs/ref/#model.ParseRule.tag"><code>tag</code></a> in a parse rule can
be a CSS selector, so you can do thing like <code>&quot;div.myclass&quot;</code> too.
Similarly, <a href="/docs/ref/#model.ParseRule.style"><code>style</code></a> matches inline CSS
styles.</p>
<p>When a schema includes <code>parseDOM</code> annotations, you can create a
<a href="/docs/ref/#model.DOMParser"><code>DOMParser</code></a> object for it with
<a href="/docs/ref/#model.DOMParser%5EfromSchema"><code>DOMParser.fromSchema</code></a>. This is done
by the editor to create the default clipboard parser, but you can
also <a href="/docs/ref/#view.EditorProps.clipboardParser">override</a> that.</p>
<p>Documents also come with a built-in JSON serialization format. You can
call <a href="/docs/ref/#model.Node.toJSON"><code>toJSON</code></a> on them to get an object that can
safely be passed to
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>JSON.stringify</code></a>,
and schema objects have a <a href="/docs/ref/#model.Schema.nodeFromJSON"><code>nodeFromJSON</code> method</a>
that can parse this representation back into a document.</p>
<h3><a id="schema.extending_a_schema"></a>Extending a schema</h3>
<p>The <code>nodes</code> and <code>marks</code> options passed to the <a href="/docs/ref/#model.Schema"><code>Schema</code>
constructor</a> take <a href="https://github.com/marijnh/orderedmap#readme"><code>OrderedMap</code>
objects</a> as well as
plain JavaScript objects. The resulting schema's
<a href="/docs/ref/#model.Schema.spec"><code>spec</code></a><code>.nodes</code> and <code>spec.marks</code> properties are
always <code>OrderedMap</code>s, which can be used as the basis for further
schemas.</p>
<p>Such maps support a number of methods to conveniently create updated
versions. For example you could say
<code>schema.spec.nodes.remove(&quot;blockquote&quot;)</code> to derive a set of nodes
without the <code>blockquote</code> node, which can then be passed as the <code>nodes</code>
field for a new schema.</p>
<p>The <a href="/docs/ref/#schema-list">schema-list</a> module exports a <a href="/docs/ref/#schema-list.addListNodes">convenience
method</a> to add the nodes exported by those
modules to a nodeset.</p>
<h2 id=transform>Document transformations</h2><p><a href="/docs/ref/#transform.Transform">Transforms</a> are central to the way ProseMirror
works. They form the basis for <a href="#state.transactions">transactions</a>,
and are what makes history tracking and collaborative editing
possible.</p>
<h3><a id="transform.why"></a>Why?</h3>
<p>Why can't we just mutate the document and be done with it? Or at least
create a new version of a document and just put that into the editor?</p>
<p>There are several reasons. One is code clarity. Immutable data
structures really do lead to simpler code. But the main thing the
transform system does is to leave a <em>trail</em> of updates, in the form of
values that represent the individual steps taken to go from an old
version of the document to a new one.</p>
<p>The <a href="/docs/ref/#history">undo history</a> can save these steps and apply their
inverse to go back in time (ProseMirror implements selective undo,
which is more complicated than just rolling back to a previous state).</p>
<p>The <a href="http://marijnhaverbeke.nl/blog/collaborative-editing.html">collaborative
editing</a>
system sends these steps to other editors and reorders them if
necessary so that everyone ends up with the same document.</p>
<p>More generally, it is very useful for editor plugins to be able to
inspect and react to each change as it comes in, in order to keep
their own state consistent with the rest of the editor state.</p>
<h3><a id="transform.steps"></a>Steps</h3>
<p>Updates to documents are decomposed into <a href="/docs/ref/#transform.Step">steps</a>
that describe an update. You usually don't need to work with these
directly, but it is useful to know how they work.</p>
<p>Examples of steps are <a href="/docs/ref/#transform.ReplaceStep"><code>ReplaceStep</code></a> to
replace a piece of a document, or
<a href="/docs/ref/#transform.AddMarkStep"><code>AddMarkStep</code></a> to add a mark to a given
range.</p>
<p>A step can be <a href="/docs/ref/#transform.Step.apply">applied</a> to a document to
produce a new document.</p>
<pre><code class="language-javascript"><span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">myDoc</span><span class="tok-operator">.</span><span class="tok-propertyName">toString</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → p(&quot;hello&quot;)</span>
<span class="tok-comment">// A step that deletes the content between positions 3 and 5</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">step</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">ReplaceStep</span><span class="tok-punctuation">(</span><span class="tok-number">3</span><span class="tok-punctuation">,</span> <span class="tok-number">5</span><span class="tok-punctuation">,</span> <span class="tok-variableName">Slice</span><span class="tok-operator">.</span><span class="tok-propertyName">empty</span><span class="tok-punctuation">)</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">result</span> <span class="tok-operator">=</span> <span class="tok-variableName">step</span><span class="tok-operator">.</span><span class="tok-propertyName">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName">myDoc</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">result</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">toString</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → p(&quot;heo&quot;)</span>
</code></pre>
<p>Applying a step is a relatively straightforward process—it doesn't do
anything clever like inserting nodes to preserve schema constraints,
or transforming the slice to make it fit. That means applying a step
can fail, for example if you try to delete just the opening token of a
node, that would leave the tokens unbalanced, which isn't a meaningful
thing you can do. This is why <a href="/docs/ref/#transform.Step.apply"><code>apply</code></a>
returns a <a href="/docs/ref/#transform.StepResult">result object</a>, which holds either
a new document, <em>or</em> an error message.</p>
<p>You'll usually want to let <a href="/docs/ref/#transform.Transform.replace">helper
functions</a> generate your steps for you,
so that you don't have to worry about the details.</p>
<h3><a id="transform.transforms"></a>Transforms</h3>
<p>An editing action may produce one or more steps. The most convenient
way to work with a sequence of steps is to create a <a href="/docs/ref/#transform.Transform"><code>Transform</code>
object</a> (or, if you're working with a full
editor state, a <a href="/docs/ref/#state.Transaction"><code>Transaction</code></a>, which is a
subclass of <code>Transform</code>).</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">tr</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Transform</span><span class="tok-punctuation">(</span><span class="tok-variableName">myDoc</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">delete</span><span class="tok-punctuation">(</span><span class="tok-number">5</span><span class="tok-punctuation">,</span> <span class="tok-number">7</span><span class="tok-punctuation">)</span> <span class="tok-comment">// Delete between position 5 and 7</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">split</span><span class="tok-punctuation">(</span><span class="tok-number">5</span><span class="tok-punctuation">)</span>     <span class="tok-comment">// Split the parent node at position 5</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">toString</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// The modified document</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span><span class="tok-punctuation">)</span>   <span class="tok-comment">// → 2</span>
</code></pre>
<p>Most transform methods return the transform itself, for convenient
chaining (allowing you to do <code>tr.delete(5, 7).split(5)</code>).</p>
<p>There are transform methods for
<a href="/docs/ref/#transform.Transform.delete">deleting</a> and
<a href="/docs/ref/#transform.Transform.replace">replacing</a>, for
<a href="/docs/ref/#transform.Transform.addMark">adding</a> and <a href="/docs/ref/#transform.Transform.removeMark">removing
marks</a>, for performing tree
manipulation like <a href="/docs/ref/#transform.Transform.split">splitting</a>,
<a href="/docs/ref/#transform.Transform.join">joining</a>,
<a href="/docs/ref/#transform.Transform.lift">lifting</a>, and
<a href="/docs/ref/#transform.Transform.wrap">wrapping</a>, and more.</p>
<h3><a id="transform.mapping"></a>Mapping</h3>
<p>When you make a change to a document, positions pointing into that
document may become invalid or change meaning. For example, if you
insert a character, all positions after that character now point one
token before their old position. Similarly, if you delete all the
content in a document, all positions pointing into that content are
now invalid.</p>
<p>We often do need to preserve positions across document changes, for
example the selection boundaries. To help with this, steps can give
you a <a href="/docs/ref/#transform.StepMap"><em>map</em></a> that can convert between positions
in the document before and after applying the step.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">step</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">ReplaceStep</span><span class="tok-punctuation">(</span><span class="tok-number">4</span><span class="tok-punctuation">,</span> <span class="tok-number">6</span><span class="tok-punctuation">,</span> <span class="tok-variableName">Slice</span><span class="tok-operator">.</span><span class="tok-propertyName">empty</span><span class="tok-punctuation">)</span> <span class="tok-comment">// Delete 4-5</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">map</span> <span class="tok-operator">=</span> <span class="tok-variableName">step</span><span class="tok-operator">.</span><span class="tok-propertyName">getMap</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">map</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-number">8</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 6</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">map</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-number">2</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 2 (nothing changes before the change)</span>
</code></pre>
<p>Transform objects automatically
<a href="/docs/ref/#transform.Transform.mapping">accumulate</a> a set of maps for the
steps in them, using an abstraction called
<a href="/docs/ref/#transform.Mapping"><code>Mapping</code></a>, which collects a series of step maps
and allows you to map through them in one go.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">tr</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Transform</span><span class="tok-punctuation">(</span><span class="tok-variableName">myDoc</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">split</span><span class="tok-punctuation">(</span><span class="tok-number">10</span><span class="tok-punctuation">)</span>    <span class="tok-comment">// split a node, +2 tokens at 10</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">delete</span><span class="tok-punctuation">(</span><span class="tok-number">2</span><span class="tok-punctuation">,</span> <span class="tok-number">5</span><span class="tok-punctuation">)</span> <span class="tok-comment">// -3 tokens at 2</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">mapping</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-number">15</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 14</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">mapping</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-number">6</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>  <span class="tok-comment">// → 3</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">mapping</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-number">10</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 9</span>
</code></pre>
<p>There are cases where it's not entirely clear what a given position
should be mapped to. Consider the last line of the example above.
Position 10 points precisely at the point where we split a node,
inserting two tokens. Should it be mapped to the position <em>after</em> the
inserted content, or stay in front of it? In the example, it is
apparently moved after the inserted tokens.</p>
<p>But sometimes you want the other behavior, which is why the <a href="/docs/ref/#transform.Mappable.map"><code>map</code>
method</a> on step maps and mappings accepts a
second parameter, <code>bias</code>, which you can set to -1 to keep your
position in place when content is inserted on top of it.</p>
<pre><code class="language-javascript"><span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">mapping</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-number">10</span><span class="tok-punctuation">,</span> <span class="tok-operator">-</span><span class="tok-number">1</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 7</span>
</code></pre>
<p>The reason that individual steps are defined as small, straightforward
things is that it makes this kind of mapping possible, along with
<a href="/docs/ref/#transform.Step.invert">inverting</a> steps in a lossless way, and
mapping steps through each other's position maps.</p>
<h3><a id="transform.rebasing"></a>Rebasing</h3>
<p>When doing more complicated things with steps and position maps, for
example to implement your own change tracking, or to integrate some
feature with collaborative editing, you might run into the need to
<em>rebase</em> steps.</p>
<p>You might not want to bother studying this until you are sure you need
it.</p>
<p>Rebasing, in the simple case, is the process of taking two steps that
start with the same document, and transform one of them so that it can
be applied to the document created by the other instead. In pseudocode:</p>
<pre><code>stepA(doc) = docA
stepB(doc) = docB
stepB(docA) = MISMATCH!
rebase(stepB, mapA) = stepB'
stepB'(docA) = docAB
</code></pre>
<p>Steps have a <a href="/docs/ref/#transform.Step.map"><code>map</code> method</a>, which, given a
mapping, maps the whole step through it. This can fail, since some
steps don't make sense anymore when, for example, the content they
applied to has been deleted. But when it succeeds, you now have a step
pointing into a new document, i.e. the one after the changes that you
mapped through. So in the above example, <code>rebase(stepB, mapA)</code> can
simply call <code>stepB.map(mapA)</code>.</p>
<p>Things get more complicated when you want to rebase a chain of steps
over another chain of steps.</p>
<pre><code>stepA2(stepA1(doc)) = docA
stepB2(stepB1(doc)) = docB
???(docA) = docAB
</code></pre>
<p>We can map <code>stepB1</code> over <code>stepA1</code> and then <code>stepA2</code>, to get <code>stepB1'</code>.
But with <code>stepB2</code>, which starts at the document produced by
<code>stepB1(doc)</code>, and whose mapped version must apply to the document
produced by <code>stepB1'(docA)</code>, things get more difficult. It must be
mapped over the following chain of maps:</p>
<pre><code>rebase(stepB2, [invert(mapB1), mapA1, mapA2, mapB1'])
</code></pre>
<p>I.e. first the inverse of the map for <code>stepB1</code> to get back to the
original document, then through the pipeline of maps produced by
applying <code>stepA1</code> and <code>stepA2</code>, and finally through the map produced
by applying <code>stepB1'</code> to <code>docA</code>.</p>
<p>If there was a <code>stepB3</code>, we'd get the pipeline for that one by taking
the one above, prefixing it with <code>invert(mapB2)</code> and adding <code>mapB2'</code>
to the end. And so on.</p>
<p>But when <code>stepB1</code> inserted some content, and <code>stepB2</code> did something to
that content, then mapping <code>stepB2</code> through <code>invert(mapB1)</code> will
return <code>null</code>, because the inverse of <code>stepB1</code> <em>deletes</em> the content
to which it applies. However, this content is reintroduced later in
the pipeline, by <code>mapB1</code>. The <a href="/docs/ref/#transform.Mapping"><code>Mapping</code></a>
abstraction provides a way to track such pipelines, including the
inverse relations between the maps in it. You can map steps through it
in such a way that they survive situations like the one above.</p>
<p>Even if you have rebased a step, there is no guarantee that it can
still be validly applied to the current document. For example, if your
step adds a mark, but another step changed the parent node of your
target content to be a node that doesn't allow marks, trying to apply
your step will fail. The appropriate response to this is usually just
to drop the step.</p>
<h2 id=state>The editor state</h2><p>What makes up the state of an editor? You have your document, of
course. And also the current selection. And there needs to be a way to
store the fact that the current set of marks has changed, when you for
example disable or enable a mark but haven't started typing with that
mark yet.</p>
<p>Those are the three main components of a ProseMirror state, and exist
on state objects as <a href="/docs/ref/#state.EditorState.doc"><code>doc</code></a>,
<a href="/docs/ref/#state.EditorState.selection"><code>selection</code></a>, and
<a href="/docs/ref/#state.EditorState.storedMarks"><code>storedMarks</code></a>.</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">schema</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-schema-basic&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">EditorState</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-state&quot;</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">toString</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-comment">// An empty paragraph</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span><span class="tok-punctuation">)</span> <span class="tok-comment">// 1, the start of the paragraph</span>
</code></pre>
<p>But plugins may also need to store state—for example, the undo history
has to keep its history of changes. This is why the set of active
plugins is also stored in the state, and these plugins can define
additional slots for storing their own state.</p>
<h3><a id="state.selection"></a>Selection</h3>
<p>ProseMirror supports several types of selection (and allows 3rd-party
code to define new selection types). Selections are represented by
instances of (subclasses of) the <a href="/docs/ref/#state.Selection"><code>Selection</code></a>
class. Like documents and other state-related values, they are
immutable—to change the selection, you create a new selection object
and a new state to hold it.</p>
<p>Selections have, at the very least, a start
(<a href="/docs/ref/#state.Selection.from"><code>.from</code></a>) and an end
(<a href="/docs/ref/#state.Selection.to"><code>.to</code></a>), as positions pointing into the
current document. Many selection types also distinguish between the
<a href="/docs/ref/#state.Selection.anchor"><em>anchor</em></a> (unmoveable) and
<a href="/docs/ref/#state.Selection.head"><em>head</em></a> (moveable) side of the selection, so
those are also required to exist on every selection object.</p>
<p>The most common type of selection is a <a href="/docs/ref/#state.TextSelection">text
selection</a>, which is used for regular cursors
(when <code>anchor</code> and <code>head</code> are the same) or selected text. Both
endpoints of a text selection are required to be in inline positions,
i.e. pointing into nodes that allow inline content.</p>
<p>The core library also supports <a href="/docs/ref/#state.NodeSelection">node
selections</a>, where a single document node is
selected, which you get, for example, when you ctrl/cmd-click a node.
Such a selection ranges from the position directly before the node to
the position directly after it.</p>
<h3><a id="state.transactions"></a>Transactions</h3>
<p>During normal editing, new states will be derived from the state
before them. You may in some situations, such as loading a new
document, want to create a completely new state, but this is the
exception.</p>
<p>State updates happen by <a href="/docs/ref/#state.EditorState.apply">applying</a> a
<a href="/docs/ref/#state.Transaction">transaction</a> to an existing state, producing a
new state. Conceptually, they happen in a single shot: given the old
state and the transaction, a new value is computed for each component
of the state, and those are put together in a new state value.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">tr</span> <span class="tok-operator">=</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span><span class="tok-punctuation">)</span> <span class="tok-comment">// 25</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">insertText</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;hello&quot;</span><span class="tok-punctuation">)</span> <span class="tok-comment">// Replaces selection with 'hello'</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">newState</span> <span class="tok-operator">=</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span><span class="tok-punctuation">)</span> <span class="tok-comment">// 30</span>
</code></pre>
<p><a href="/docs/ref/#state.Transaction"><code>Transaction</code></a> is a subclass of
<a href="/docs/ref/#transform.Transform"><code>Transform</code></a>, and inherits the way it builds
up a new document by applying <a href="/docs/ref/#transform.Step">steps</a> to an initial
document. In addition to this, transactions track selection and other
state-related components, and get some selection-related convenience
methods such as
<a href="/docs/ref/#state.Transaction.replaceSelection"><code>replaceSelection</code></a>.</p>
<p>The easiest way to create a transaction is with the <a href="/docs/ref/#state.EditorState.tr"><code>tr</code>
getter</a> on an editor state object. This
creates an empty transaction based on that state, to which you can
then add steps and other updates.</p>
<p>By default, the old selection is <a href="/docs/ref/#state.Selection.map">mapped</a>
through each step to produce a new selection, but it is possible to
use <a href="/docs/ref/#state.Transaction.setSelection"><code>setSelection</code></a> to explicitly
set a new selection.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">tr</span> <span class="tok-operator">=</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 10</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">delete</span><span class="tok-punctuation">(</span><span class="tok-number">6</span><span class="tok-punctuation">,</span> <span class="tok-number">8</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 8 (moved back)</span>
<span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">setSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName">TextSelection</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">,</span> <span class="tok-number">3</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
<span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span><span class="tok-punctuation">)</span> <span class="tok-comment">// → 3</span>
</code></pre>
<p>Similarly, the <a href="/docs/ref/#state.EditorState.storedMarks">set of active marks</a>
is automatically cleared after a document or selection change, and can
be set using the
<a href="/docs/ref/#state.Transaction.setStoredMarks"><code>setStoredMarks</code></a> or
<a href="/docs/ref/#state.Transaction.ensureMarks"><code>ensureMarks</code></a> methods.</p>
<p>Finally, the <a href="/docs/ref/#state.Transaction.scrollIntoView"><code>scrollIntoView</code></a>
method can be used to ensure that, the next time the state is drawn,
the selection is scrolled into view. You probably want to do that for
most user actions.</p>
<p>Like <code>Transform</code> methods, many <code>Transaction</code> methods return the
transaction itself, for convenient chaining.</p>
<h3><a id="state.plugins"></a>Plugins</h3>
<p>When <a href="/docs/ref/#state.EditorState%5Ecreate">creating</a> a new state, you can
provide an array of plugins to use. These will be stored in the state
and any state that is derived from it, and can influence both the way
transactions are applied and the way an editor based on this state
behaves.</p>
<p>Plugins are instances of the <a href="/docs/ref/#state.Plugin"><code>Plugin</code> class</a>, and can
model a wide variety of features. The simplest ones just add some
<a href="/docs/ref/#view.EditorProps">props</a> to the editor view, for example to respond
to certain events. More complicated ones might add new state to the
editor and update it based on transactions.</p>
<p>When creating a plugin, you pass it <a href="/docs/ref/#state.PluginSpec">an object</a>
specifying its behavior:</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">myPlugin</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Plugin</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">props</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">handleKeyDown</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">view</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">event</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;A key was pressed!&quot;</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">return</span> <span class="tok-bool">false</span> <span class="tok-comment">// We did not handle this</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">state</span> <span class="tok-operator">=</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">plugins</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">[</span><span class="tok-variableName">myPlugin</span><span class="tok-punctuation">]</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>When a plugin needs its own state slot, that is defined with a
<a href="/docs/ref/#state.PluginSpec.state"><code>state</code></a> property:</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">transactionCounter</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Plugin</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">init</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-number">0</span> <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">tr</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">value</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-variableName">value</span> <span class="tok-operator">+</span> <span class="tok-number">1</span> <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">getTransactionCount</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">return</span> <span class="tok-variableName">transactionCounter</span><span class="tok-operator">.</span><span class="tok-propertyName">getState</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>The plugin in the example defines a very simple piece of state that
simply counts the number of transactions that have been applied to a
state. The helper function uses the plugin's
<a href="/docs/ref/#state.Plugin.getState"><code>getState</code></a> method, which can be used to
fetch the plugin state from a full editor state object.</p>
<p>Because the editor state is a persistent (immutable) object, and
plugin state is part of that object, plugin state values must be
immutable. I.e. their <code>apply</code> method must return a new value, rather
than changing the old, if they need to change, and no other code
should change them.</p>
<p>It is often useful for plugins to add some extra information to a
transaction. For example, the undo history, when performing an actual
undo, will mark the resulting transaction, so that when the plugin
sees it, instead of doing the thing it normally does with changes
(adding them to the undo stack), it treats it specially, removing the
top item from the undo stack and adding this transaction to the redo
stack instead.</p>
<p>For this purpose, transactions allow
<a href="/docs/ref/#state.Transaction.getMeta"><em>metadata</em></a> to be attached to them. We
could update our transaction counter plugin to not count transactions
that are marked, like this:</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">transactionCounter</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Plugin</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">init</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-number">0</span> <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">tr</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">value</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">getMeta</span><span class="tok-punctuation">(</span><span class="tok-variableName">transactionCounter</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-variableName">value</span>
      <span class="tok-keyword">else</span> <span class="tok-keyword">return</span> <span class="tok-variableName">value</span> <span class="tok-operator">+</span> <span class="tok-number">1</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">markAsUncounted</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">tr</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">setMeta</span><span class="tok-punctuation">(</span><span class="tok-variableName">transactionCounter</span><span class="tok-punctuation">,</span> <span class="tok-bool">true</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>Keys for metadata properties can be strings, but to avoid name
collisions, you are encouraged to use plugin objects. There are some
string keys that are given a meaning by the library, for example
<code>&quot;addToHistory&quot;</code> can be set to <code>false</code> to prevent a transaction from
being undoable, and when handling a paste, the editor view will set
the <code>&quot;paste&quot;</code> property on the resulting transaction to true.</p>
<h2 id=view>The view component</h2><style>
  .box {
    color: white;
    display: inline-block;
    border-radius: 5px;
    padding: 6px 10px;
    margin: 3px 0;
    vertical-align: top;
  }
</style>
<p>A ProseMirror <a href="/docs/ref/#view.EditorView">editor view</a> is a user interface
component that displays an <a href="#state">editor state</a> to the user, and
allows them to perform editing actions on it.</p>
<p>The definition of <em>editing actions</em> used by the core view component is
rather narrow—it handles direct interaction with the editing surface,
such as typing, clicking, copying, pasting, and dragging, but not much
beyond that. This means that things like displaying a menu, or even
providing a full set of key bindings, lie outside of the
responsibility of the core view component, and have to be arranged
through plugins.</p>
<h3><a id="view.editable_dom"></a>Editable DOM</h3>
<p>Browsers allow us to specify that some parts of the DOM are
<a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/contentEditable">editable</a>,
which has the effect of allowing focus and a selection in them, and
making it possible to type into them. The view creates a DOM
representation of its document (using your schema's <a href="/docs/ref/#model.NodeSpec.toDOM"><code>toDOM</code>
methods</a> by default), and makes it editable.
When the editable element is focused, ProseMirror makes sure that the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection">DOM
selection</a>
corresponds to the selection in the editor state.</p>
<p>It also registers event handlers for many DOM events, which translate
the events into the appropriate <a href="#state.transactions">transactions</a>.
For example, when pasting, the pasted content is
<a href="/docs/ref/#view.EditorProps.clipboardParser">parsed</a> as a ProseMirror document
slice, and then inserted into the document.</p>
<p>Many events are also let through as they are, and only <em>then</em>
reinterpreted in terms of ProseMirror's data model. The browser is
quite good at cursor and selection placement for example (which is a
really difficult problem when you factor in bidirectional text), so
most cursor-motion related keys and mouse actions are handled by the
browser, after which ProseMirror checks what kind of <a href="/docs/ref/#state.TextSelection">text
selection</a> the current DOM selection would
correspond to. If that selection is different from the current
selection, a transaction that updates the selection is dispatched.</p>
<p>Even typing is usually left to the browser, because interfering with
that tends to break spell-checking, autocapitalizing on some mobile
interfaces, and other native features. When the browser updates the
DOM, the editor notices, re-parses the changed part of the document,
and translates the difference into a transaction.</p>
<h3><a id="view.data_flow"></a>Data flow</h3>
<p>So the editor view displays a given editor state, and when something
happens, it creates a transaction and broadcasts this. This
transaction is then, typically, used to create a new state, which is
given to the view using its
<a href="/docs/ref/#view.EditorView.updateState"><code>updateState</code></a> method.</p>
<div style="text-align: center; font-size: 140%">
  <div class=box style="background: #c33;"><strong>DOM event</strong></div>
  <div>↗<span style="width: 5em; display: inline-block;"></span>↘</div>
  <div>
    <div class=box style="margin-right: 4em; background: #55b"><strong>EditorView</strong></div>
    <div class=box style="background: #77e"><strong>Transaction</strong></div>
  </div>
  <div>↖<span style="width: 5em; display: inline-block;"></span>↙</div>
  <div class=box style="background: #446;">new <strong>EditorState</strong></div>
</div>
<p>This creates a straightforward, cyclic data flow, as opposed to the
classic approach (in the JavaScript world) of a host of imperative
event handlers, which tends to create a much more complex web of data
flows.</p>
<p>It is possible to ‘intercept’ transactions as they are
<a href="/docs/ref/#view.EditorView.dispatch">dispatched</a> with the
<a href="/docs/ref/#view.DirectEditorProps.dispatchTransaction"><code>dispatchTransaction</code> prop</a>,
in order to wire this cyclic data flow into a larger cycle—if your
whole app is using a data flow model like this, as with
<a href="https://github.com/reactjs/redux">Redux</a> and similar architectures,
you can integrate ProseMirror's transactions in your main
action-dispatching cycle, and keep ProseMirror's state in your
application ‘store’.</p>
<pre><code class="language-javascript"><span class="tok-comment">// The app's state</span>
<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">appState</span> <span class="tok-operator">=</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">editor</span><span class="tok-punctuation">:</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">schema</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">score</span><span class="tok-punctuation">:</span> <span class="tok-number">0</span>
<span class="tok-punctuation">}</span>

<span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">body</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">:</span> <span class="tok-variableName">appState</span><span class="tok-operator">.</span><span class="tok-propertyName">editor</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">dispatchTransaction</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">transaction</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-variableName">update</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">type</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;EDITOR_TRANSACTION&quot;</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">transaction</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-comment">// A crude app state update function, which takes an update object,</span>
<span class="tok-comment">// updates the `appState`, and then refreshes the UI.</span>
<span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">update</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">event</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">event</span><span class="tok-operator">.</span><span class="tok-propertyName">type</span> <span class="tok-operator">==</span> <span class="tok-string">&quot;EDITOR_TRANSACTION&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-variableName">appState</span><span class="tok-operator">.</span><span class="tok-propertyName">editor</span> <span class="tok-operator">=</span> <span class="tok-variableName">appState</span><span class="tok-operator">.</span><span class="tok-propertyName">editor</span><span class="tok-operator">.</span><span class="tok-propertyName">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName">event</span><span class="tok-operator">.</span><span class="tok-propertyName">transaction</span><span class="tok-punctuation">)</span>
  <span class="tok-keyword">else</span> <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">event</span><span class="tok-operator">.</span><span class="tok-propertyName">type</span> <span class="tok-operator">==</span> <span class="tok-string">&quot;SCORE_POINT&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-variableName">appState</span><span class="tok-operator">.</span><span class="tok-propertyName">score</span><span class="tok-operator">++</span>
  <span class="tok-variableName">draw</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span>

<span class="tok-comment">// An even cruder drawing function</span>
<span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">draw</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">querySelector</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;#score&quot;</span><span class="tok-punctuation">)</span><span class="tok-operator">.</span><span class="tok-propertyName">textContent</span> <span class="tok-operator">=</span> <span class="tok-variableName">appState</span><span class="tok-operator">.</span><span class="tok-propertyName">score</span>
  <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">updateState</span><span class="tok-punctuation">(</span><span class="tok-variableName">appState</span><span class="tok-operator">.</span><span class="tok-propertyName">editor</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span>
</code></pre>
<h3><a id="view.efficient_updating"></a>Efficient updating</h3>
<p>One way to implement <a href="/docs/ref/#view.EditorView.updateState"><code>updateState</code></a>
would be to simply redraw the document every time it is called. But
for large documents, that would be really slow.</p>
<p>Since, at the time of updating, the view has access to both the old
document and the new, it can compare them, and leave the parts of the
DOM that correspond to unchanged nodes alone. ProseMirror does this,
allowing it to do very little work for typical updates.</p>
<p>In some cases, like updates that correspond to typed text, which was
already added to the DOM by the browser's own editing actions,
ensuring the DOM and state are coherent doesn't require any DOM
changes at all. (When such a transaction is canceled or modified
somehow, the view <em>will</em> undo the DOM change to make sure the DOM and
the state remain synchronized.)</p>
<p>Similarly, the DOM selection is only updated when it is actually out
of sync with the selection in the state, to avoid disrupting the
various pieces of ‘hidden’ state that browsers keep along with the
selection (such as that feature where when you arrow down or up past a
short line, your horizontal position goes back to where it was when you
enter the next long line).</p>
<h3><a id="view.props"></a>Props</h3>
<p>‘Props’ is a useful, if somewhat vague, term taken from
<a href="https://facebook.github.io/react/docs/components-and-props.html">React</a>.
Props are like parameters to a UI component. Ideally, the set of props
that the component gets completely defines its behavior.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">:</span> <span class="tok-variableName">myState</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">editable</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span> <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span> <span class="tok-comment">// Enables read-only behavior</span>
  <span class="tok-propertyName tok-definition">handleDoubleClick</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;Double click!&quot;</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>As such, the current <a href="/docs/ref/#view.DirectEditorProps.state">state</a> is one
prop. The value of other props can also vary over time, if the code
that controls the component <a href="/docs/ref/#view.EditorView.setProps">updates</a>
them, but aren't considered <em>state</em>, because the component itself
won't change them. The <a href="/docs/ref/#view.EditorView.updateState"><code>updateState</code></a>
method is just a shorthand to updating the <a href="/docs/ref/#view.DirectEditorProps.state"><code>state</code>
prop</a>.</p>
<p>Plugins are also allowed to <a href="/docs/ref/#state.PluginSpec.props">declare</a> props,
except for <a href="/docs/ref/#view.DirectEditorProps.state"><code>state</code></a> and
<a href="/docs/ref/#view.DirectEditorProps.dispatchTransaction"><code>dispatchTransaction</code></a>,
which can only be provided directly to the view.</p>
<pre><code class="language-javascript"><span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">maxSizePlugin</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">max</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">return</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Plugin</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">props</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
      <span class="tok-propertyName tok-definition">editable</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span> <span class="tok-operator">&lt;</span> <span class="tok-variableName">max</span> <span class="tok-punctuation">}</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>When a given prop is declared multiple times, how it is handled
depends on the prop. In general, directly provided props take
precedence, after which each plugin gets a turn, in order. For some
props, such as <a href="/docs/ref/#view.EditorProps.domParser"><code>domParser</code></a>, the first
value that is found is used, and others are ignored. For handler
functions that return a boolean to indicate whether they handled the
event, the first one that returns true gets to handle the event. And
finally, for some props, such as
<a href="/docs/ref/#view.EditorProps.attributes"><code>attributes</code></a> (which can be used to
set attributes on the editable DOM node) and
<a href="/docs/ref/#view.EditorProps.decorations"><code>decorations</code></a> (which we'll get to in
the next section), the union of all provided values is used.</p>
<h3><a id="view.decorations"></a>Decorations</h3>
<p>Decorations give you some control over the way the view draws your
document. They are created by returning values from the <a href="/docs/ref/#view.EditorProps.decorations"><code>decorations</code>
prop</a>, and come in three types:</p>
<ul>
<li>
<p><a href="/docs/ref/#view.Decoration%5Enode">Node decorations</a> add styling or other DOM
attributes to a single node's DOM representation.</p>
</li>
<li>
<p><a href="/docs/ref/#view.Decoration%5Ewidget">Widget decorations</a> <em>insert</em> a DOM node,
which isn't part of the actual document, at a given position.</p>
</li>
<li>
<p><a href="/docs/ref/#view.Decoration%5Einline">Inline decorations</a> add styling or
attributes, much like node decorations, but to all inline nodes in
a given range.</p>
</li>
</ul>
<p>In order to be able to efficiently draw and compare decorations, they
need to be provided as a <a href="/docs/ref/#view.DecorationSet">decoration set</a> (which
is a data structure that mimics the tree shape of the actual
document). You create one using the static <a href="/docs/ref/#view.DecorationSet%5Ecreate"><code>create</code>
method</a>, providing the document and an
array of decoration objects:</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">purplePlugin</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Plugin</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">props</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">decorations</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">return</span> <span class="tok-variableName">DecorationSet</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">[</span>
        <span class="tok-variableName">Decoration</span><span class="tok-operator">.</span><span class="tok-propertyName">inline</span><span class="tok-punctuation">(</span><span class="tok-number">0</span><span class="tok-punctuation">,</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">style</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;color: purple&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
      <span class="tok-punctuation">]</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>When you have a lot of decorations, recreating the set on the fly for
every redraw is likely to be too expensive. In such cases, the
recommended way to maintain your decorations is to put the set in your
plugin's state, <a href="/docs/ref/#view.DecorationSet.map">map</a> it forward through
changes, and only change it when you need to.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">specklePlugin</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">Plugin</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">init</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">_</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">speckles</span> <span class="tok-operator">=</span> <span class="tok-punctuation">[</span><span class="tok-punctuation">]</span>
      <span class="tok-keyword">for</span> <span class="tok-punctuation">(</span><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">pos</span> <span class="tok-operator">=</span> <span class="tok-number">1</span><span class="tok-punctuation">;</span> <span class="tok-variableName">pos</span> <span class="tok-operator">&lt;</span> <span class="tok-variableName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span><span class="tok-punctuation">;</span> <span class="tok-variableName">pos</span> <span class="tok-operator">+=</span> <span class="tok-number">4</span><span class="tok-punctuation">)</span>
        <span class="tok-variableName">speckles</span><span class="tok-operator">.</span><span class="tok-propertyName">push</span><span class="tok-punctuation">(</span><span class="tok-variableName">Decoration</span><span class="tok-operator">.</span><span class="tok-propertyName">inline</span><span class="tok-punctuation">(</span><span class="tok-variableName">pos</span> <span class="tok-operator">-</span> <span class="tok-number">1</span><span class="tok-punctuation">,</span> <span class="tok-variableName">pos</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">style</span><span class="tok-punctuation">:</span> <span class="tok-string">&quot;background: yellow&quot;</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">return</span> <span class="tok-variableName">DecorationSet</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-variableName">doc</span><span class="tok-punctuation">,</span> <span class="tok-variableName">speckles</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">tr</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">set</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-variableName">set</span><span class="tok-operator">.</span><span class="tok-propertyName">map</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">mapping</span><span class="tok-punctuation">,</span> <span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">props</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">decorations</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-variableName">specklePlugin</span><span class="tok-operator">.</span><span class="tok-propertyName">getState</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<p>This plugin initializes its state to a decoration set that adds a
yellow-background inline decoration to every 4th position. That's not
terribly useful, but sort of resembles use cases like highlighting
search matches or annotated regions.</p>
<p>When a transaction is applied to the state, the plugin state's
<a href="/docs/ref/#state.StateField.apply"><code>apply</code> method</a> maps the decoration set
forward, causing the decorations to stay in place and ‘fit’ the new
document shape. The mapping method is (for typical, local changes)
made efficient by exploiting the tree shape of the decoration set—only
the parts of the tree that are actually touched by the changes need to
be rebuilt.</p>
<p>(In a real-world plugin, the <code>apply</code> method would also be the place
where you <a href="/docs/ref/#view.DecorationSet.add">add</a> or
<a href="/docs/ref/#view.DecorationSet.remove">remove</a> decorations based on new events,
possibly by inspecting the changes in the transaction, or based on
plugin-specific metadata attached to the transaction.)</p>
<p>Finally, the <code>decorations</code> prop simply returns the plugin state,
causing the decorations to show up in the view.</p>
<h3><a id="view.node_views"></a>Node views</h3>
<p>There is one more way in which you can influence the way the editor
view draws your document. <a href="/docs/ref/#view.NodeView">Node views</a> make it
possible to <a href="/docs/ref/#view.EditorProps.nodeViews">define</a> a sort of miniature
UI components for individual nodes in your document. They allow you to
render their DOM, define the way they are updated, and write custom
code to react to events.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">nodeViews</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">image</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-keyword">new</span> <span class="tok-variableName">ImageView</span><span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-keyword">class</span> <span class="tok-className">ImageView</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">constructor</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-comment">// The editor will use this as the node's DOM representation</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span> <span class="tok-operator">=</span> <span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">createElement</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;img&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">src</span> <span class="tok-operator">=</span> <span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">attrs</span><span class="tok-operator">.</span><span class="tok-propertyName">src</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">addEventListener</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;click&quot;</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">e</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-punctuation">{</span>
      <span class="tok-variableName">console</span><span class="tok-operator">.</span><span class="tok-propertyName">log</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;You clicked me!&quot;</span><span class="tok-punctuation">)</span>
      <span class="tok-variableName">e</span><span class="tok-operator">.</span><span class="tok-propertyName">preventDefault</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>

  <span class="tok-propertyName tok-definition">stopEvent</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-bool">true</span> <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>The view object that the example defines for image nodes creates its
own custom DOM node for the image, with an event handler added, and
declares, with a <code>stopEvent</code> method, that ProseMirror should ignore
events coming from that DOM node.</p>
<p>You'll often want interaction with the node to have some effect on the
actual node in the document. But to create a transaction that changes
a node, you first need to know where that node is. To help with that,
node views get passed a getter function that can be used to query
their current position in the document. Let's modify the example so
that clicking on the node queries you to enter an alt text for the
image:</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">nodeViews</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">image</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">view</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">getPos</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-keyword">new</span> <span class="tok-variableName">ImageView</span><span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-punctuation">,</span> <span class="tok-variableName">view</span><span class="tok-punctuation">,</span> <span class="tok-variableName">getPos</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-keyword">class</span> <span class="tok-className">ImageView</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">constructor</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">view</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">getPos</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span> <span class="tok-operator">=</span> <span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">createElement</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;img&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">src</span> <span class="tok-operator">=</span> <span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">attrs</span><span class="tok-operator">.</span><span class="tok-propertyName">src</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">alt</span> <span class="tok-operator">=</span> <span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">attrs</span><span class="tok-operator">.</span><span class="tok-propertyName">alt</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">addEventListener</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;click&quot;</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">e</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-punctuation">{</span>
      <span class="tok-variableName">e</span><span class="tok-operator">.</span><span class="tok-propertyName">preventDefault</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">alt</span> <span class="tok-operator">=</span> <span class="tok-variableName">prompt</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;New alt text:&quot;</span><span class="tok-punctuation">,</span> <span class="tok-string">&quot;&quot;</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">alt</span><span class="tok-punctuation">)</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">setNodeMarkup</span><span class="tok-punctuation">(</span><span class="tok-variableName">getPos</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span> <span class="tok-keyword">null</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span>
        <span class="tok-propertyName tok-definition">src</span><span class="tok-punctuation">:</span> <span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">attrs</span><span class="tok-operator">.</span><span class="tok-propertyName">src</span><span class="tok-punctuation">,</span>
        <span class="tok-propertyName tok-definition">alt</span>
      <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>

  <span class="tok-propertyName tok-definition">stopEvent</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-bool">true</span> <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p><a href="/docs/ref/#transform.Transform.setNodeMarkup"><code>setNodeMarkup</code></a> is a method that
can be used to change the type or set of attributes for the node at a
given position. In the example, we use <code>getPos</code> to find our image's
current position, and give it a new attribute object with the new alt
text.</p>
<p>When a node is updated, the default behavior is to leave its outer DOM
structure intact and compare its children to the new set of children,
updating or replacing those as needed. A node view can override this
with custom behavior, which allows us to do something like changing
the class of a paragraph based on its content.</p>
<pre><code class="language-javascript"><span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">nodeViews</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">paragraph</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-keyword">new</span> <span class="tok-variableName">ParagraphView</span><span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

<span class="tok-keyword">class</span> <span class="tok-className">ParagraphView</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">constructor</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">contentDOM</span> <span class="tok-operator">=</span> <span class="tok-variableName">document</span><span class="tok-operator">.</span><span class="tok-propertyName">createElement</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;p&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span> <span class="tok-operator">==</span> <span class="tok-number">0</span><span class="tok-punctuation">)</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">classList</span><span class="tok-operator">.</span><span class="tok-propertyName">add</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;empty&quot;</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>

  <span class="tok-propertyName tok-definition">update</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">type</span><span class="tok-operator">.</span><span class="tok-propertyName">name</span> <span class="tok-operator">!=</span> <span class="tok-string">&quot;paragraph&quot;</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">content</span><span class="tok-operator">.</span><span class="tok-propertyName">size</span> <span class="tok-operator">&gt;</span> <span class="tok-number">0</span><span class="tok-punctuation">)</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">classList</span><span class="tok-operator">.</span><span class="tok-propertyName">remove</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;empty&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">else</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">classList</span><span class="tok-operator">.</span><span class="tok-propertyName">add</span><span class="tok-punctuation">(</span><span class="tok-string">&quot;empty&quot;</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>Images never have content, so in our previous example, we didn't need
to worry about how that would be rendered. But paragraphs do have
content. Node views support two approaches to handling content: you
can let the ProseMirror library manage it, or you can manage it
entirely yourself. If you provide a <a href="/docs/ref/#view.NodeView.contentDOM"><code>contentDOM</code>
property</a>, the library will render the
node's content into that, and handle content updates. If you don't,
the content becomes a black box to the editor, and how you display it
and let the user interact with it is entirely up to you.</p>
<p>In this case, we want paragraph content to behave like regular
editable text, so the <code>contentDOM</code> property is defined to be the same
as the <code>dom</code> property, since the content needs to be rendered directly
into the outer node.</p>
<p>The magic happens in the <a href="/docs/ref/#view.NodeView.update"><code>update</code> method</a>.
Firstly, this method is responsible for deciding whether the node view
<em>can</em> be updated to show the new node at all. This new node may be
anything that the editor's update algorithm might try to draw here, so
you must verify that this is a node that this node view can handle.</p>
<p>The <code>update</code> method in the example first checks whether the new node
is a paragraph, and bails out if that's not the case. Then it makes
sure that the <code>&quot;empty&quot;</code> class is present or absent, depending on the
content of the new node, and returns true, to indicate that the update
succeeded (at which point the node's content will be updated).</p>
<h2 id=commands>Commands</h2><p>In ProseMirror jargon, a <em>command</em> is a function that implements an
editing action, which the user can perform by pressing some key
combination or interacting with the menu.</p>
<p>For practical reasons, commands have a slightly convoluted interface.
In their simple form, they are functions taking an <a href="#state">editor
state</a> and a <em>dispatch function</em>
(<a href="/docs/ref/#view.EditorView.dispatch"><code>EditorView.dispatch</code></a> or some other
function that takes transactions), and return a boolean. Here's a
very simple example:</p>
<pre><code class="language-javascript"><span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">deleteSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">dispatch</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">empty</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
  <span class="tok-variableName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">deleteSelection</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
  <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>When a command isn't applicable, it should return false and do
nothing. When it is, it should dispatch a transaction and return true.
This is used, for example, by the <a href="/docs/ref/#keymap">keymap plugin</a> to stop
further handling of key events when the command bound to that key has
been applied.</p>
<p>To be able to query whether a command is applicable for a given state,
without actually executing it, the <code>dispatch</code> argument is
optional—commands should simply return true without doing anything
when they are applicable but no <code>dispatch</code> argument is given. So the
example command should actually look like this:</p>
<pre><code class="language-javascript"><span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">deleteSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">dispatch</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">empty</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
  <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">dispatch</span><span class="tok-punctuation">)</span> <span class="tok-variableName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">deleteSelection</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
  <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>To figure out whether a selection can currently be deleted, you'd call
<code>deleteSelection(view.state, null)</code>, whereas to actually execute the
command, you'd do something like <code>deleteSelection(view.state, view.dispatch)</code>. A menu bar could use this to determine which menu
items to gray out.</p>
<p>In this form, commands do not get access to the actual editor
view—most commands don't need that, and in this way they can be
applied and tested in settings that don't have a view available. But
some commands do need to interact with the DOM—they might need to
<a href="/docs/ref/#view.EditorView.endOfTextblock">query</a> whether a given position is
at the end of a textblock, or want to open a dialog positioned
relative to the view. For this purpose, most plugins that call
commands will give them a <em>third</em> argument, which is the whole view.</p>
<pre><code class="language-javascript"><span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">blinkView</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">_state</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">dispatch</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">view</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">dispatch</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">style</span><span class="tok-operator">.</span><span class="tok-propertyName">background</span> <span class="tok-operator">=</span> <span class="tok-string">&quot;yellow&quot;</span>
    <span class="tok-variableName">setTimeout</span><span class="tok-punctuation">(</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span><span class="tok-operator">.</span><span class="tok-propertyName">style</span><span class="tok-operator">.</span><span class="tok-propertyName">background</span> <span class="tok-operator">=</span> <span class="tok-string">&quot;&quot;</span><span class="tok-punctuation">,</span> <span class="tok-number">1000</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>
  <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>That (rather useless) example shows that commands don't <em>have</em> to
dispatch a transaction—they are called for their side effect, which is
<em>usually</em> to dispatch a transaction, but may also be something else,
such as popping up a dialog.</p>
<p>The <a href="/docs/ref/#commands"><code>prosemirror-commands</code></a> module provides a number of
editing commands, from simple ones such as a variant of the
<a href="/docs/ref/#commands.deleteSelection"><code>deleteSelection</code></a> command, to rather
complicated ones such as <a href="/docs/ref/#commands.joinBackward"><code>joinBackward</code></a>,
which implements the block-joining behavior that should happen when
you press backspace at the start of a textblock. It also comes with a
<a href="/docs/ref/#commands.baseKeymap">basic keymap</a> that binds a number of
schema-agnostic commands to the keys that are usually used for them.</p>
<p>When possible, different behavior, even when usually bound to a single
key, is put in different commands. The utility function
<a href="/docs/ref/#commands.chainCommands"><code>chainCommands</code></a> can be used to combine a
number of commands—they will be tried one after the other until one
return true.</p>
<p>For example, the base keymap binds backspace to the command chain
<a href="/docs/ref/#commands.deleteSelection"><code>deleteSelection</code></a> (which kicks in when
the selection isn't empty), <a href="/docs/ref/#commands.joinBackward"><code>joinBackward</code></a>
(when the cursor is at the start of a textblock), and
<a href="/docs/ref/#commands.selectNodeBackward"><code>selectNodeBackward</code></a> (which selects
the node before the selection, in case the schema forbids the regular
joining behavior). When none of these apply, the browser is allowed to
run its own backspace behavior, which is the appropriate thing for
backspacing things out inside a textblock (so that native spell-check
and such don't get confused).</p>
<p>The commands module also exports a number of command constructors,
such as <a href="/docs/ref/#commands.toggleMark"><code>toggleMark</code></a>, which takes a mark type
and optionally a set of attributes, and returns a command function
that toggles that mark on the current selection.</p>
<p>Some other modules also export command functions—for example
<a href="/docs/ref/#history.undo"><code>undo</code></a> and <a href="/docs/ref/#history.redo"><code>redo</code></a> from the history
module. To customize your editor, or to allow users to interact with
custom document nodes, you'll likely want to write your own custom
commands as well.</p>
<h2 id=collab>Collaborative editing</h2><p>Real-time collaborative editing allows multiple people to edit the
same document at the same time. Changes they make are applied
immediately to their local document, and then sent to peers, which
merge in these changes automatically (without manual conflict
resolution), so that editing can proceed uninterrupted, and the
documents keep converging.</p>
<p>This guide describes how to wire up ProseMirror's collaborative
editing functionality.</p>
<h3><a id="collab.algorithm"></a>Algorithm</h3>
<p>ProseMirror's collaborative editing system employs a central authority
which determines in which order changes are applied. If two editors
make changes concurrently, they will both go to this authority with
their changes. The authority will accept the changes from one of them,
and broadcast these changes to all editors. The other's changes will
not be accepted, and when that editor receives new changes from the
server, it'll have to <a href="#transform.rebasing">rebase</a> its local
changes on top of those from the other editor, and try to submit them
again.</p>
<h3><a id="collab.the_authority"></a>The Authority</h3>
<p>The role of the central authority is actually rather simple. It must...</p>
<ul>
<li>
<p>Track a current document version</p>
</li>
<li>
<p>Accept changes from editors, and when these can be applied, add
them to its list of changes</p>
</li>
<li>
<p>Provide a way for editors to receive changes since a given version</p>
</li>
</ul>
<p>Let's implement a trivial central authority that runs in the same
JavaScript environment as the editors.</p>
<pre><code class="language-javascript"><span class="tok-keyword">class</span> <span class="tok-className">Authority</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">constructor</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">doc</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span> <span class="tok-operator">=</span> <span class="tok-variableName">doc</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span> <span class="tok-operator">=</span> <span class="tok-punctuation">[</span><span class="tok-punctuation">]</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">stepClientIDs</span> <span class="tok-operator">=</span> <span class="tok-punctuation">[</span><span class="tok-punctuation">]</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">onNewSteps</span> <span class="tok-operator">=</span> <span class="tok-punctuation">[</span><span class="tok-punctuation">]</span>
  <span class="tok-punctuation">}</span>

  <span class="tok-propertyName tok-definition">receiveSteps</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">version</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">steps</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">clientID</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">version</span> <span class="tok-operator">!=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span>

    <span class="tok-comment">// Apply and accumulate new steps</span>
    <span class="tok-variableName">steps</span><span class="tok-operator">.</span><span class="tok-propertyName">forEach</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">step</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span> <span class="tok-operator">=</span> <span class="tok-variableName">step</span><span class="tok-operator">.</span><span class="tok-propertyName">apply</span><span class="tok-punctuation">(</span><span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">)</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-operator">.</span><span class="tok-propertyName">push</span><span class="tok-punctuation">(</span><span class="tok-variableName">step</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">stepClientIDs</span><span class="tok-operator">.</span><span class="tok-propertyName">push</span><span class="tok-punctuation">(</span><span class="tok-variableName">clientID</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
    <span class="tok-comment">// Signal listeners</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">onNewSteps</span><span class="tok-operator">.</span><span class="tok-propertyName">forEach</span><span class="tok-punctuation">(</span><span class="tok-keyword">function</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">f</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-variableName">f</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>

  <span class="tok-propertyName tok-definition">stepsSince</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">version</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">return</span> <span class="tok-punctuation">{</span>
      <span class="tok-propertyName tok-definition">steps</span><span class="tok-punctuation">:</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-operator">.</span><span class="tok-propertyName">slice</span><span class="tok-punctuation">(</span><span class="tok-variableName">version</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
      <span class="tok-propertyName tok-definition">clientIDs</span><span class="tok-punctuation">:</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">stepClientIDs</span><span class="tok-operator">.</span><span class="tok-propertyName">slice</span><span class="tok-punctuation">(</span><span class="tok-variableName">version</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>When an editor wants to try and submit their changes to the authority,
they can call <code>receiveSteps</code> on it, passing the last version number
they received, along with the new changes they added, and their client
ID (which is a way for them to later recognize which changes came from
them).</p>
<p>When the steps are accepted, the client will notice because the
authority notifies them that new steps are available, and then give
them <em>their own</em> steps. In a real implementation, you could also have
<code>receiveSteps</code> return a status, and immediately confirm the sent
steps, as an optimization. But the mechanism used here is necessary to
guarantee synchronization on unreliable connections, so you should
always use it as the base case.</p>
<p>This implementation of an authority keeps an endlessly growing array
of steps, the length of which denotes its current version.</p>
<h3><a id="collab.the_collab_module"></a>The <code>collab</code> Module</h3>
<p>The <a href="/docs/ref/#collab"><code>collab</code></a> module exports a <a href="/docs/ref/#collab.collab"><code>collab</code></a>
function which returns a plugin that takes care of tracking local
changes, receiving remote changes, and indicating when something has
to be sent to the central authority.</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">EditorState</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-state&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">EditorView</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-view&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">schema</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-schema-basic&quot;</span>
<span class="tok-keyword">import</span> <span class="tok-variableName tok-definition">collab</span> <span class="tok-keyword">from</span> <span class="tok-string">&quot;prosemirror-collab&quot;</span>

<span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">collabEditor</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">authority</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">place</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">EditorView</span><span class="tok-punctuation">(</span><span class="tok-variableName">place</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span>
    <span class="tok-propertyName tok-definition">state</span><span class="tok-punctuation">:</span> <span class="tok-variableName">EditorState</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
      <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-variableName">authority</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">,</span>
      <span class="tok-propertyName tok-definition">plugins</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">[</span><span class="tok-variableName">collab</span><span class="tok-operator">.</span><span class="tok-propertyName">collab</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">version</span><span class="tok-punctuation">:</span> <span class="tok-variableName">authority</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span><span class="tok-punctuation">]</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
    <span class="tok-propertyName tok-definition">dispatchTransaction</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">transaction</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">newState</span> <span class="tok-operator">=</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">apply</span><span class="tok-punctuation">(</span><span class="tok-variableName">transaction</span><span class="tok-punctuation">)</span>
      <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">updateState</span><span class="tok-punctuation">(</span><span class="tok-variableName">newState</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">sendable</span> <span class="tok-operator">=</span> <span class="tok-variableName">collab</span><span class="tok-operator">.</span><span class="tok-propertyName">sendableSteps</span><span class="tok-punctuation">(</span><span class="tok-variableName">newState</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">sendable</span><span class="tok-punctuation">)</span>
        <span class="tok-variableName">authority</span><span class="tok-operator">.</span><span class="tok-propertyName">receiveSteps</span><span class="tok-punctuation">(</span><span class="tok-variableName">sendable</span><span class="tok-operator">.</span><span class="tok-propertyName">version</span><span class="tok-punctuation">,</span> <span class="tok-variableName">sendable</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-punctuation">,</span>
                               <span class="tok-variableName">sendable</span><span class="tok-operator">.</span><span class="tok-propertyName">clientID</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

  <span class="tok-variableName">authority</span><span class="tok-operator">.</span><span class="tok-propertyName">onNewSteps</span><span class="tok-operator">.</span><span class="tok-propertyName">push</span><span class="tok-punctuation">(</span><span class="tok-keyword">function</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">newData</span> <span class="tok-operator">=</span> <span class="tok-variableName">authority</span><span class="tok-operator">.</span><span class="tok-propertyName">stepsSince</span><span class="tok-punctuation">(</span><span class="tok-variableName">collab</span><span class="tok-operator">.</span><span class="tok-propertyName">getVersion</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
    <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">(</span>
      <span class="tok-variableName">collab</span><span class="tok-operator">.</span><span class="tok-propertyName">receiveTransaction</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName">newData</span><span class="tok-operator">.</span><span class="tok-propertyName">steps</span><span class="tok-punctuation">,</span> <span class="tok-variableName">newData</span><span class="tok-operator">.</span><span class="tok-propertyName">clientIDs</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

  <span class="tok-keyword">return</span> <span class="tok-variableName">view</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p>The <code>collabEditor</code> function creates an editor view that has the
<code>collab</code> plugin loaded. Whenever the state is updated, it checks
whether there is anything to send to the authority. If so, it sends
it.</p>
<p>It also registers a function that the authority should call when new
steps are available, and which creates a <a href="/docs/ref/#state.Transaction">transaction</a>
that updates our local editor state to reflect those steps.</p>
<p>When a set of steps gets rejected by the authority, they will remain
unconfirmed until, supposedly soon after, we receive new steps from
the authority. After that happens, because the <code>onNewSteps</code> callback
calls <code>dispatch</code>, which will call our <code>dispatchTransaction</code> function,
the code will try to submit its changes again.</p>
<p>That's all there is to it. Of course, with asynchronous data channels
(such as long polling in
<a href="https://github.com/ProseMirror/website/blob/master/src/collab/client/collab.js">the collab demo</a>
or web sockets), you'll need somewhat more complicated communication
and synchronization code. And you'll probably also want your authority
to start throwing away steps at some point, so that its memory
consumption doesn't grow without bound. But the general approach is
fully described by this little example.</p>
</article>

<footer>
  <nav>
    <a class=logo href=".">&nbsp;</a>
    <div class=navlinks>
      <a href="/backers.html">Backers</a>
      <a href="http://contributor-covenant.org/version/1/1/0/">Code of Conduct</a>
      <a href="https://discuss.prosemirror.net/">Discuss</a>
      <a href="https://github.com/prosemirror/prosemirror/issues">Report an Issue</a>
    </div>
  </nav>
</footer>

</html>