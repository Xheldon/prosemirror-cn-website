<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf8">
<meta name="viewport" content="width=device-width, initial-scale=1"><title>ProseMirror embedded editor example</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/site.css">

<script src="https://www.googletagmanager.com/gtag/js?id=G-KQYXRE0B3X"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-KQYXRE0B3X')</script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5486286026923411"></script></head><body><div id="banner-info">本文档为 GPT-4o + 人工翻译，hover 可以显示原文。<a style="cursor: pointer;" href="https://prosemirror-old.xheldon.com/examples/codemirror/" target="_blank">原始翻译地址</a>。翻译有问题？<a style="cursor: pointer;" href="https://github.com/Xheldon/prosemirror-cn-website/blob/main/dict/examples/codemirror/index.json" target="_blank">我来翻译！</a></div><header>
  <nav>
    <a class="logo" href="/">ProseMirror</a>
    <div class="navlinks"><a href="/examples/" class="active">示例</a>
      <a href="/docs/">文档</a>
      <a href="https://discuss.prosemirror.net/">论坛</a>
      <a href="https://github.com/prosemirror">GitHub</a>
      <a href="https://twitter.com/prosemirror">Twitter</a>
    <a href="https://www.xheldon.com" target="_blank">译者</a></div>
  </nav></header><article>
<style>
  /* hover 显示原文 */
  p[data-x-en],
  li[data-x-en] {
    position: relative;
  }
  p[data-x-en]:hover::after,
  li[data-x-en]:hover::after {
    visibility: visible;
    opacity: 1;
  }
  p[data-x-en]::after,
  li[data-x-en]::after {
    content: attr(data-x-en);
    display: block;
    font-size: 12px;
    transition: all 0.2s 0.3s;
    visibility: hidden;
    opacity: 0;
    background: #cccccc;
    z-index: 99;
    border-radius: 4px;
    padding: 5px 10px;
    position: absolute;
    top: 100%;
    left: 0;
  }
  /* 译者注释内容 */
  p[type='comment'] {
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 12px;
    background: #eee;
  }
  p[type='comment']::before {
    content: '译者注: ';
    font-weight: 900;
  }
  header a.logo {
    position: relative;
  }
  header a.logo::after {
    content: '中文';
    position: absolute;
    left: calc(100% + 5px);
    font-size: 12px;
    width: 50px;
    top: -5px;
  }
  #banner-info {
    position: fixed;
    top: 0;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    background: #fff;
    font-size: 14px;
    padding: 5px 0;
    z-index: 999;
  }
  #add-info {
    font-size: 14px;
  }
  blockquote {
    border-left: 5px solid #ccc;
    padding-left: 10px;
    margin-left: 0;
  }
</style><h1>Embedded code editor</h1>
<p data-x-en="It can be useful to have the in-document representation of some node, such as a code block, math formula, or image, show up as a custom editor control specifically for such content. Node views are a ProseMirror feature that make this possible.">在文档中显示某些节点（例如代码块、数学公式或图像）的自定义编辑器控件可能会很有用。<a href="/docs/ref/#view.NodeView">节点视图</a>是一个使这成为可能的ProseMirror功能。</p>
<p data-x-en="In this example, we set up code blocks, as they exist in the basic schema, to be rendered as instances of CodeMirror, a code editor component. The general idea is quite similar to the footnote example, but instead of popping up the node-specific editor when the user selects the node, it is always visible.">在这个例子中，我们设置了代码块，正如它们在<a href="/docs/ref/#schema-basic">基本模式</a>中存在的那样，以<a href="http://codemirror.net">CodeMirror</a>（一个代码编辑器组件）的实例形式呈现。总体思路与<a href="../footnote/">脚注示例</a>非常相似，但不是在用户选择节点时弹出节点特定的编辑器，而是始终可见。</p>
<p data-x-en="Wiring such a node view and keymap into an editor gives us something like this:">将这样的节点视图和键映射连接到编辑器中，会得到如下结果：</p>
<div id="editor"></div>
<div id="content" style="display: none">
<h3>代码块是一个代码编辑器</h3>
<p data-x-en="This editor has been wired up to render code blocks as instances of the CodeMirror code editor, which provides syntax highlighting, auto-indentation, and similar.">这个编辑器已经连接起来，将代码块渲染为<a href="http://codemirror.net">CodeMirror</a>代码编辑器的实例，提供语法高亮、自动缩进等功能。</p>
<pre>function max(a, b) {
  return a &gt; b ? a : b
}</pre>
<p data-x-en="The content of the code editor is kept in sync with the content of the code block in the rich text editor, so that it is as if you're directly editing the outer document, using a more convenient interface.">代码编辑器的内容与富文本编辑器中的代码块内容保持同步，这样就像是在使用更方便的界面直接编辑外部文档。</p>
</div>
<style>
  .CodeMirror {
    border: 1px solid #eee;
    height: auto;
  }
  .CodeMirror pre { white-space: pre !important }
</style>
<p data-x-en="Because we want changes in the code editor to be reflected in the ProseMirror document, our node view must flush changes to its content to ProseMirror as soon as they happen. To allow ProseMirror commands to act on the right selection, the code editor will also sync its current selection to ProseMirror.">因为我们希望代码编辑器中的更改能够反映在ProseMirror文档中，我们的节点视图必须在内容发生更改时立即将其刷新到ProseMirror。为了让ProseMirror命令作用于正确的选择，代码编辑器还会将其当前选择同步到ProseMirror。</p>
<p data-x-en="The first thing we do in our code block node view is create an editor with some basic extensions, a few extra key bindings, and an update listener that will do the synchronization.">在我们的代码块节点视图中，我们首先创建一个带有一些基本扩展、一些额外键绑定和一个将进行同步的更新监听器的编辑器。</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span>
  <span class="tok-variableName">EditorView</span> <span class="tok-keyword">as</span> <span class="tok-variableName tok-definition">CodeMirror</span><span class="tok-punctuation">,</span> <span class="tok-variableName">keymap</span> <span class="tok-keyword">as</span> <span class="tok-variableName tok-definition">cmKeymap</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">drawSelection</span>
<span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"@codemirror/view"</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">javascript</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"@codemirror/lang-javascript"</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">defaultKeymap</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"@codemirror/commands"</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">syntaxHighlighting</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">defaultHighlightStyle</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"@codemirror/language"</span>

<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">exitCode</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"prosemirror-commands"</span>
<span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">undo</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">redo</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"prosemirror-history"</span>

<span class="tok-keyword">class</span> <span class="tok-className">CodeBlockView</span> <span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">constructor</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">node</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">view</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">getPos</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-comment">// 稍后存储</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span> <span class="tok-operator">=</span> <span class="tok-variableName">node</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span> <span class="tok-operator">=</span> <span class="tok-variableName">view</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">getPos</span> <span class="tok-operator">=</span> <span class="tok-variableName">getPos

    </span><span class="tok-comment">// 创建一个CodeMirror实例</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span> <span class="tok-operator">=</span> <span class="tok-keyword">new</span> <span class="tok-variableName">CodeMirror</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
      <span class="tok-propertyName tok-definition">doc</span><span class="tok-punctuation">:</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">textContent</span><span class="tok-punctuation">,</span>
      <span class="tok-propertyName tok-definition">extensions</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">[</span>
        <span class="tok-variableName">cmKeymap</span><span class="tok-operator">.</span><span class="tok-propertyName">of</span><span class="tok-punctuation">(</span><span class="tok-punctuation">[</span>
          <span class="tok-punctuation">...</span><span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">codeMirrorKeymap</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
          <span class="tok-punctuation">...</span><span class="tok-variableName">defaultKeymap</span>
        <span class="tok-punctuation">]</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
        <span class="tok-variableName">drawSelection</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
        <span class="tok-variableName">syntaxHighlighting</span><span class="tok-punctuation">(</span><span class="tok-variableName">defaultHighlightStyle</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
        <span class="tok-variableName">javascript</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
        <span class="tok-variableName">CodeMirror</span><span class="tok-operator">.</span><span class="tok-propertyName">updateListener</span><span class="tok-operator">.</span><span class="tok-propertyName">of</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">update</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">forwardUpdate</span><span class="tok-punctuation">(</span><span class="tok-variableName">update</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
      <span class="tok-punctuation">]</span>
    <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>

    <span class="tok-comment">// 编辑器的外部节点是我们的DOM表示</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">dom</span>

    <span class="tok-comment">// 此标志用于避免外部和之间的更新循环</span>
    <span class="tok-comment">// 内部编辑器</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span> <span class="tok-operator">=</span> <span class="tok-bool">false</span>
  <span class="tok-punctuation">}</span>
</code></pre>
<p data-x-en="When the code editor is focused, translate any update that changes the document or selection to a ProseMirror transaction. The getPos that was passed to the node view can be used to find out where our code content starts, relative to the outer document (the + 1 skips the code block opening token).">当代码编辑器获得焦点时，将任何更改文档或选择的更新转换为ProseMirror事务。传递给节点视图的<code>getPos</code>可用于找出我们的代码内容相对于外部文档的起始位置（<code>+ 1</code>跳过代码块的开头标记）。</p>
<pre><code class="language-javascript">  <span class="tok-variableName">forwardUpdate</span><span class="tok-punctuation">(</span><span class="tok-variableName">update</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span> <span class="tok-operator">||</span> <span class="tok-operator">!</span><span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">hasFocus</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">offset</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">getPos</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-operator">+</span> <span class="tok-number">1</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName">main</span><span class="tok-punctuation">}</span> <span class="tok-operator">=</span> <span class="tok-variableName">update</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">selFrom</span> <span class="tok-operator">=</span> <span class="tok-variableName">offset</span> <span class="tok-operator">+</span> <span class="tok-variableName">main</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">selTo</span> <span class="tok-operator">=</span> <span class="tok-variableName">offset</span> <span class="tok-operator">+</span> <span class="tok-variableName">main</span><span class="tok-operator">.</span><span class="tok-propertyName">to</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">pmSel</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">update</span><span class="tok-operator">.</span><span class="tok-propertyName">docChanged</span> <span class="tok-operator">||</span> <span class="tok-variableName">pmSel</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span> <span class="tok-operator">!=</span> <span class="tok-variableName">selFrom</span> <span class="tok-operator">||</span> <span class="tok-variableName">pmSel</span><span class="tok-operator">.</span><span class="tok-propertyName">to</span> <span class="tok-operator">!=</span> <span class="tok-variableName">selTo</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">tr</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span>
      <span class="tok-variableName">update</span><span class="tok-operator">.</span><span class="tok-propertyName">changes</span><span class="tok-operator">.</span><span class="tok-propertyName">iterChanges</span><span class="tok-punctuation">(</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">fromA</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">toA</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">fromB</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">toB</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">text</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-punctuation">{</span>
        <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">text</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span><span class="tok-punctuation">)</span>
          <span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">replaceWith</span><span class="tok-punctuation">(</span><span class="tok-variableName">offset</span> <span class="tok-operator">+</span> <span class="tok-variableName">fromA</span><span class="tok-punctuation">,</span> <span class="tok-variableName">offset</span> <span class="tok-operator">+</span> <span class="tok-variableName">toA</span><span class="tok-punctuation">,</span>
                         <span class="tok-variableName">schema</span><span class="tok-operator">.</span><span class="tok-propertyName">text</span><span class="tok-punctuation">(</span><span class="tok-variableName">text</span><span class="tok-operator">.</span><span class="tok-propertyName">toString</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
        <span class="tok-keyword">else</span>
          <span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">delete</span><span class="tok-punctuation">(</span><span class="tok-variableName">offset</span> <span class="tok-operator">+</span> <span class="tok-variableName">fromA</span><span class="tok-punctuation">,</span> <span class="tok-variableName">offset</span> <span class="tok-operator">+</span> <span class="tok-variableName">toA</span><span class="tok-punctuation">)</span>
        <span class="tok-variableName">offset</span> <span class="tok-operator">+=</span> <span class="tok-punctuation">(</span><span class="tok-variableName">toB</span> <span class="tok-operator">-</span> <span class="tok-variableName">fromB</span><span class="tok-punctuation">)</span> <span class="tok-operator">-</span> <span class="tok-punctuation">(</span><span class="tok-variableName">toA</span> <span class="tok-operator">-</span> <span class="tok-variableName">fromA</span><span class="tok-punctuation">)</span>
      <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
      <span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">setSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName">TextSelection</span><span class="tok-operator">.</span><span class="tok-propertyName">create</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-punctuation">,</span> <span class="tok-variableName">selFrom</span><span class="tok-punctuation">,</span> <span class="tok-variableName">selTo</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-punctuation">)</span>
    <span class="tok-punctuation">}</span>
  <span class="tok-punctuation">}</span>
</code></pre>
<p data-x-en="When adding steps to a transaction for content changes, the offset is adjusted for the changes in length caused by the change, so that further steps are created in the correct position.">当为内容更改添加步骤到事务时，偏移量会根据更改引起的长度变化进行调整，以便在正确的位置创建进一步的步骤。</p>
<p data-x-en="The setSelection method on a node view will be called when ProseMirror tries to put the selection inside the node. Our implementation makes sure the CodeMirror selection is set to match the position that is passed in.">当 ProseMirror 尝试将选区放入节点时，将调用节点视图上的 <code>setSelection</code> 方法。我们的实现确保 CodeMirror 选区设置为匹配传入的位置。</p>
<pre><code class="language-javascript">  <span class="tok-variableName">setSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName">anchor</span><span class="tok-punctuation">,</span> <span class="tok-variableName">head</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">focus</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span> <span class="tok-operator">=</span> <span class="tok-bool">true</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">selection</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">anchor</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">head</span><span class="tok-punctuation">}</span><span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span> <span class="tok-operator">=</span> <span class="tok-bool">false</span>
  <span class="tok-punctuation">}</span>
</code></pre>
<p data-x-en="A somewhat tricky aspect of nesting editor like this is handling cursor motion across the edges of the inner editor. This node view will have to take care of allowing the user to move the selection out of the code editor. For that purpose, it binds the arrow keys to handlers that check if further motion would ‘escape’ the editor, and if so, return the selection and focus to the outer editor.">嵌套编辑器的一个有点棘手的方面是处理光标在内部编辑器边缘的移动。这个节点视图必须负责允许用户将选择移出代码编辑器。为此，它将箭头键绑定到处理程序，这些处理程序会检查进一步的移动是否会“逃离”编辑器，如果是，则将选择和焦点返回到外部编辑器。</p>
<p data-x-en="The keymap also binds keys for undo and redo, which the outer editor will handle, and for ctrl-enter, which, in ProseMirror's base keymap, creates a new paragraph after a code block.">键映射还绑定了撤销和重做的键，这将由外部编辑器处理，以及ctrl-enter键，在ProseMirror的基本键映射中，它会在代码块后创建一个新段落。</p>
<pre><code class="language-javascript">  <span class="tok-variableName">codeMirrorKeymap</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">view</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span>
    <span class="tok-keyword">return</span> <span class="tok-punctuation">[</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"ArrowUp"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">maybeEscape</span><span class="tok-punctuation">(</span><span class="tok-string">"line"</span><span class="tok-punctuation">,</span> <span class="tok-operator">-</span><span class="tok-number">1</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"ArrowLeft"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">maybeEscape</span><span class="tok-punctuation">(</span><span class="tok-string">"char"</span><span class="tok-punctuation">,</span> <span class="tok-operator">-</span><span class="tok-number">1</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"ArrowDown"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">maybeEscape</span><span class="tok-punctuation">(</span><span class="tok-string">"line"</span><span class="tok-punctuation">,</span> <span class="tok-number">1</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"ArrowRight"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">maybeEscape</span><span class="tok-punctuation">(</span><span class="tok-string">"char"</span><span class="tok-punctuation">,</span> <span class="tok-number">1</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"Ctrl-Enter"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-punctuation">{</span>
        <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-operator">!</span><span class="tok-variableName">exitCode</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
        <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">focus</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
        <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
      <span class="tok-punctuation">}</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"Ctrl-z"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">mac</span><span class="tok-punctuation">:</span> <span class="tok-string">"Cmd-z"</span><span class="tok-punctuation">,</span>
       <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-variableName">undo</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"Shift-Ctrl-z"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">mac</span><span class="tok-punctuation">:</span> <span class="tok-string">"Shift-Cmd-z"</span><span class="tok-punctuation">,</span>
       <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-variableName">redo</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span><span class="tok-punctuation">,</span>
      <span class="tok-punctuation">{</span><span class="tok-propertyName tok-definition">key</span><span class="tok-punctuation">:</span> <span class="tok-string">"Ctrl-y"</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">mac</span><span class="tok-punctuation">:</span> <span class="tok-string">"Cmd-y"</span><span class="tok-punctuation">,</span>
       <span class="tok-propertyName tok-definition">run</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-variableName">redo</span><span class="tok-punctuation">(</span><span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">)</span><span class="tok-punctuation">}</span>
    <span class="tok-punctuation">]</span>
  <span class="tok-punctuation">}</span>

  <span class="tok-variableName">maybeEscape</span><span class="tok-punctuation">(</span><span class="tok-variableName">unit</span><span class="tok-punctuation">,</span> <span class="tok-variableName">dir</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">let</span> <span class="tok-punctuation">{</span><span class="tok-propertyName">state</span><span class="tok-punctuation">}</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-punctuation">,</span> <span class="tok-punctuation">{</span><span class="tok-propertyName">main</span><span class="tok-punctuation">}</span> <span class="tok-operator">=</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-operator">!</span><span class="tok-variableName">main</span><span class="tok-operator">.</span><span class="tok-propertyName">empty</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">unit</span> <span class="tok-operator">==</span> <span class="tok-string">"line"</span><span class="tok-punctuation">)</span> <span class="tok-variableName">main</span> <span class="tok-operator">=</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">lineAt</span><span class="tok-punctuation">(</span><span class="tok-variableName">main</span><span class="tok-operator">.</span><span class="tok-propertyName">head</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">dir</span> <span class="tok-operator">&lt;</span> <span class="tok-number">0</span> <span class="tok-operator">?</span> <span class="tok-variableName">main</span><span class="tok-operator">.</span><span class="tok-propertyName">from</span> <span class="tok-operator">&gt;</span> <span class="tok-number">0</span> <span class="tok-operator">:</span> <span class="tok-variableName">main</span><span class="tok-operator">.</span><span class="tok-propertyName">to</span> <span class="tok-operator">&lt;</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">targetPos</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">getPos</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-operator">+</span> <span class="tok-punctuation">(</span><span class="tok-variableName">dir</span> <span class="tok-operator">&lt;</span> <span class="tok-number">0</span> <span class="tok-operator">?</span> <span class="tok-number">0</span> <span class="tok-operator">:</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">nodeSize</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">selection</span> <span class="tok-operator">=</span> <span class="tok-variableName">Selection</span><span class="tok-operator">.</span><span class="tok-propertyName">near</span><span class="tok-punctuation">(</span><span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">resolve</span><span class="tok-punctuation">(</span><span class="tok-variableName">targetPos</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span> <span class="tok-variableName">dir</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">tr</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">setSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName">selection</span><span class="tok-punctuation">)</span><span class="tok-operator">.</span><span class="tok-propertyName">scrollIntoView</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-variableName">tr</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">focus</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
  <span class="tok-punctuation">}</span>
</code></pre>
<p data-x-en="When a node update comes in from ProseMirror, for example because of an undo action, we sort of have to do the inverse of what forwardUpdate did—check for text changes, and if present, propagate them from the outer to the inner editor.">当来自ProseMirror的节点更新到来时，例如由于撤销操作，我们必须做一些类似<code>forwardUpdate</code>的反向操作——检查文本更改，如果存在，则将其从外部编辑器传播到内部编辑器。</p>
<p data-x-en="To avoid needlessly clobbering the state of the inner editor, this method only generates a replacement for the range of the content that was changed, by comparing the start and end of the old and new content.">为了避免不必要地破坏内部编辑器的状态，此方法仅通过比较旧内容和新内容的开始和结束来生成更改内容范围的替换。</p>
<pre><code class="language-javascript">  <span class="tok-variableName">update</span><span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">type</span> <span class="tok-operator">!=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">type</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
    <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">node</span> <span class="tok-operator">=</span> <span class="tok-variableName">node</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span><span class="tok-punctuation">)</span> <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
    <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">newText</span> <span class="tok-operator">=</span> <span class="tok-variableName">node</span><span class="tok-operator">.</span><span class="tok-propertyName">textContent</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">curText</span> <span class="tok-operator">=</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">toString</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">newText</span> <span class="tok-operator">!=</span> <span class="tok-variableName">curText</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">start</span> <span class="tok-operator">=</span> <span class="tok-number">0</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">curEnd</span> <span class="tok-operator">=</span> <span class="tok-variableName">curText</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">newEnd</span> <span class="tok-operator">=</span> <span class="tok-variableName">newText</span><span class="tok-operator">.</span><span class="tok-propertyName">length</span>
      <span class="tok-keyword">while</span> <span class="tok-punctuation">(</span><span class="tok-variableName">start</span> <span class="tok-operator">&lt;</span> <span class="tok-variableName">curEnd</span> <span class="tok-operator">&amp;&amp;</span>
             <span class="tok-variableName">curText</span><span class="tok-operator">.</span><span class="tok-propertyName">charCodeAt</span><span class="tok-punctuation">(</span><span class="tok-variableName">start</span><span class="tok-punctuation">)</span> <span class="tok-operator">==</span> <span class="tok-variableName">newText</span><span class="tok-operator">.</span><span class="tok-propertyName">charCodeAt</span><span class="tok-punctuation">(</span><span class="tok-variableName">start</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
        <span class="tok-operator">++</span><span class="tok-variableName">start</span>
      <span class="tok-punctuation">}</span>
      <span class="tok-keyword">while</span> <span class="tok-punctuation">(</span><span class="tok-variableName">curEnd</span> <span class="tok-operator">&gt;</span> <span class="tok-variableName">start</span> <span class="tok-operator">&amp;&amp;</span> <span class="tok-variableName">newEnd</span> <span class="tok-operator">&gt;</span> <span class="tok-variableName">start</span> <span class="tok-operator">&amp;&amp;</span>
             <span class="tok-variableName">curText</span><span class="tok-operator">.</span><span class="tok-propertyName">charCodeAt</span><span class="tok-punctuation">(</span><span class="tok-variableName">curEnd</span> <span class="tok-operator">-</span> <span class="tok-number">1</span><span class="tok-punctuation">)</span> <span class="tok-operator">==</span> <span class="tok-variableName">newText</span><span class="tok-operator">.</span><span class="tok-propertyName">charCodeAt</span><span class="tok-punctuation">(</span><span class="tok-variableName">newEnd</span> <span class="tok-operator">-</span> <span class="tok-number">1</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
        <span class="tok-variableName">curEnd</span><span class="tok-operator">--</span>
        <span class="tok-variableName">newEnd</span><span class="tok-operator">--</span>
      <span class="tok-punctuation">}</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span> <span class="tok-operator">=</span> <span class="tok-bool">true</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
        <span class="tok-propertyName tok-definition">changes</span><span class="tok-punctuation">:</span> <span class="tok-punctuation">{</span>
          <span class="tok-propertyName tok-definition">from</span><span class="tok-punctuation">:</span> <span class="tok-variableName">start</span><span class="tok-punctuation">,</span> <span class="tok-propertyName tok-definition">to</span><span class="tok-punctuation">:</span> <span class="tok-variableName">curEnd</span><span class="tok-punctuation">,</span>
          <span class="tok-propertyName tok-definition">insert</span><span class="tok-punctuation">:</span> <span class="tok-variableName">newText</span><span class="tok-operator">.</span><span class="tok-propertyName">slice</span><span class="tok-punctuation">(</span><span class="tok-variableName">start</span><span class="tok-punctuation">,</span> <span class="tok-variableName">newEnd</span><span class="tok-punctuation">)</span>
        <span class="tok-punctuation">}</span>
      <span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">updating</span> <span class="tok-operator">=</span> <span class="tok-bool">false</span>
    <span class="tok-punctuation">}</span>
    <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
  <span class="tok-punctuation">}</span>
</code></pre>
<p data-x-en="The updating property is used to disable the event listener on the code editor, so that it doesn't try to forward the change (which just came from ProseMirror) back to ProseMirror."><code>updating</code> 属性用于禁用代码编辑器上的事件监听器，这样它就不会尝试将更改（刚刚从 ProseMirror 来的）转发回 ProseMirror。</p>
<pre><code class="language-javascript">
  <span class="tok-variableName">selectNode</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">this</span><span class="tok-operator">.</span><span class="tok-propertyName">cm</span><span class="tok-operator">.</span><span class="tok-propertyName">focus</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">}</span>
  <span class="tok-variableName">stopEvent</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span> <span class="tok-keyword">return</span> <span class="tok-bool">true</span> <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span>
</code></pre>
<p data-x-en="Handling cursor motion from the outer to the inner editor must be done with a keymap on the outer editor, because the browser's native behavior won't handle this. The arrowHandler function uses the endOfTextblock method to determine, in a bidi-text-aware way, whether the cursor is at the end of a given textblock. If it is, and the next block is a code block, the selection is moved into it.">处理从外部编辑器到内部编辑器的光标移动必须在外部编辑器上使用键映射，因为浏览器的原生行为无法处理这一点。<code>arrowHandler</code>函数使用<a href="/docs/ref/#view.EditorView.endOfTextblock"><code>endOfTextblock</code>方法</a>以双向文本感知的方式确定光标是否位于给定文本块的末尾。如果是，并且下一个块是代码块，则将选择移动到其中。</p>
<pre><code class="language-javascript"><span class="tok-keyword">import</span> <span class="tok-punctuation">{</span><span class="tok-variableName tok-definition">keymap</span><span class="tok-punctuation">}</span> <span class="tok-keyword">from</span> <span class="tok-string">"prosemirror-keymap"</span>

<span class="tok-keyword">function</span> <span class="tok-variableName tok-definition">arrowHandler</span><span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">dir</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
  <span class="tok-keyword">return</span> <span class="tok-punctuation">(</span><span class="tok-variableName tok-definition">state</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">dispatch</span><span class="tok-punctuation">,</span> <span class="tok-variableName tok-definition">view</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">=&gt;</span> <span class="tok-punctuation">{</span>
    <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">empty</span> <span class="tok-operator">&amp;&amp;</span> <span class="tok-variableName">view</span><span class="tok-operator">.</span><span class="tok-propertyName">endOfTextblock</span><span class="tok-punctuation">(</span><span class="tok-variableName">dir</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">side</span> <span class="tok-operator">=</span> <span class="tok-variableName">dir</span> <span class="tok-operator">==</span> <span class="tok-string">"left"</span> <span class="tok-operator">||</span> <span class="tok-variableName">dir</span> <span class="tok-operator">==</span> <span class="tok-string">"up"</span> <span class="tok-operator">?</span> <span class="tok-operator">-</span><span class="tok-number">1</span> <span class="tok-operator">:</span> <span class="tok-number">1</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">$head</span> <span class="tok-operator">=</span> <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">selection</span><span class="tok-operator">.</span><span class="tok-propertyName">$head</span>
      <span class="tok-keyword">let</span> <span class="tok-variableName tok-definition">nextPos</span> <span class="tok-operator">=</span> <span class="tok-variableName">Selection</span><span class="tok-operator">.</span><span class="tok-propertyName">near</span><span class="tok-punctuation">(</span>
        <span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">doc</span><span class="tok-operator">.</span><span class="tok-propertyName">resolve</span><span class="tok-punctuation">(</span><span class="tok-variableName">side</span> <span class="tok-operator">&gt;</span> <span class="tok-number">0</span> <span class="tok-operator">?</span> <span class="tok-variableName">$head</span><span class="tok-operator">.</span><span class="tok-propertyName">after</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span> <span class="tok-operator">:</span> <span class="tok-variableName">$head</span><span class="tok-operator">.</span><span class="tok-propertyName">before</span><span class="tok-punctuation">(</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span> <span class="tok-variableName">side</span><span class="tok-punctuation">)</span>
      <span class="tok-keyword">if</span> <span class="tok-punctuation">(</span><span class="tok-variableName">nextPos</span><span class="tok-operator">.</span><span class="tok-propertyName">$head</span> <span class="tok-operator">&amp;&amp;</span> <span class="tok-variableName">nextPos</span><span class="tok-operator">.</span><span class="tok-propertyName">$head</span><span class="tok-operator">.</span><span class="tok-propertyName">parent</span><span class="tok-operator">.</span><span class="tok-propertyName">type</span><span class="tok-operator">.</span><span class="tok-propertyName">name</span> <span class="tok-operator">==</span> <span class="tok-string">"code_block"</span><span class="tok-punctuation">)</span> <span class="tok-punctuation">{</span>
        <span class="tok-variableName">dispatch</span><span class="tok-punctuation">(</span><span class="tok-variableName">state</span><span class="tok-operator">.</span><span class="tok-propertyName">tr</span><span class="tok-operator">.</span><span class="tok-propertyName">setSelection</span><span class="tok-punctuation">(</span><span class="tok-variableName">nextPos</span><span class="tok-punctuation">)</span><span class="tok-punctuation">)</span>
        <span class="tok-keyword">return</span> <span class="tok-bool">true</span>
      <span class="tok-punctuation">}</span>
    <span class="tok-punctuation">}</span>
    <span class="tok-keyword">return</span> <span class="tok-bool">false</span>
  <span class="tok-punctuation">}</span>
<span class="tok-punctuation">}</span>

<span class="tok-keyword">const</span> <span class="tok-variableName tok-definition">arrowHandlers</span> <span class="tok-operator">=</span> <span class="tok-variableName">keymap</span><span class="tok-punctuation">(</span><span class="tok-punctuation">{</span>
  <span class="tok-propertyName tok-definition">ArrowLeft</span><span class="tok-punctuation">:</span> <span class="tok-variableName">arrowHandler</span><span class="tok-punctuation">(</span><span class="tok-string">"left"</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">ArrowRight</span><span class="tok-punctuation">:</span> <span class="tok-variableName">arrowHandler</span><span class="tok-punctuation">(</span><span class="tok-string">"right"</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">ArrowUp</span><span class="tok-punctuation">:</span> <span class="tok-variableName">arrowHandler</span><span class="tok-punctuation">(</span><span class="tok-string">"up"</span><span class="tok-punctuation">)</span><span class="tok-punctuation">,</span>
  <span class="tok-propertyName tok-definition">ArrowDown</span><span class="tok-punctuation">:</span> <span class="tok-variableName">arrowHandler</span><span class="tok-punctuation">(</span><span class="tok-string">"down"</span><span class="tok-punctuation">)</span>
<span class="tok-punctuation">}</span><span class="tok-punctuation">)</span>
</code></pre>
<link rel="stylesheet" href="../../css/editor.css">
<script src="../prosemirror.js"></script>
<script src="example.js"></script></article>

<footer>
  <nav>
    <a class="logo" href=".">&nbsp;</a>
    <div class="navlinks">
      <a href="/backers.html">Backers</a>
      <a href="http://contributor-covenant.org/version/1/1/0/">Code of Conduct</a>
      <a href="https://discuss.prosemirror.net/">Discuss</a>
      <a href="https://github.com/prosemirror/prosemirror/issues">Report an Issue</a>
    </div>
  </nav>
</footer>

</body></html>